<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìƒí’ˆë“±ë¡ (ì´ë¯¸ì§€ ì—…ë¡œë“œ) - WeNers</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
body { font-family: Arial; width: 400px; margin: 30px auto;}
input, textarea {width: 100%; padding: 8px; margin-bottom:10px;}
button { width: 100%; padding:10px; background:#0066ff;color:white; font-weight:bold;}
</style>
</head>
<body>

<h2>ğŸ›’ ì‹ ê·œ ìƒí’ˆ ë“±ë¡</h2>

<input id="title" placeholder="ìƒí’ˆ ì œëª©"/>
<textarea id="desc" placeholder="ì„¤ëª…"></textarea>
<input id="price_start" type="number" placeholder="ì‹œì‘ê°€"/>
<input id="price_end" type="number" placeholder="ì¦‰ì‹œêµ¬ë§¤ê°€(ì„ íƒ)"/>
<input id="image" type="file"/>

<button onclick="submitProduct()">ğŸ“Œ ìƒí’ˆ ë“±ë¡</button>
<p><a href="weners_with_bids_realtime_auth.html">â† ëª©ë¡ìœ¼ë¡œ</a></p>

<script>
// ğŸ”¥ Supabase ì—°ê²° â€” config.jsì˜ KEY/URL ì‚¬ìš©
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ë¡œê·¸ì¸ ì²´í¬
supabase.auth.getSession().then(({ data })=>{
 if(!data.session) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.");
    location.href="auth_login.html";
 }
});

// ğŸ“Œ ìƒí’ˆ ì—…ë¡œë“œ
async function submitProduct(){
 const file = document.getElementById("image").files[0];
 if(!file) return alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");

 const fileName = `${Date.now()}_${file.name}`;

 // storage ì—…ë¡œë“œ
 const { data:imgData, error:imgErr } = await supabase
     .storage.from("product-images")
     .upload(fileName, file);

 if(imgErr) return alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: "+imgErr.message);

 const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/product-images/${fileName}`;

 // DB ì €ì¥
 const { error } = await supabase.from("products").insert({
     title: title.value,
     description: desc.value,
     price_start: Number(price_start.value),
     price_end: Number(price_end.value),
     images: imageUrl,
     created_at: new Date(),
 });

 if(error) return alert("DB ì €ì¥ ì˜¤ë¥˜: "+error.message);

 alert("ğŸ‰ ìƒí’ˆ ë“±ë¡ ì™„ë£Œ!");
 location.href="weners_with_bids_realtime_auth.html";
}
</script>

<script type="module">
// Minimal Supabase client init (persistSession:false to avoid auto login restore)
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
let SUPABASE_URL, SUPABASE_ANON_KEY;
try{
  const mod = await import('./config.js').catch(()=>null);
  if(mod && (mod.SUPABASE_URL || mod.default?.SUPABASE_URL)){
    SUPABASE_URL = mod.SUPABASE_URL || mod.default?.SUPABASE_URL;
    SUPABASE_ANON_KEY = mod.SUPABASE_ANON_KEY || mod.default?.SUPABASE_ANON_KEY;
  } else {
    SUPABASE_URL = window.SUPABASE_URL;
    SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
  }
}catch(e){
  SUPABASE_URL = window.SUPABASE_URL;
  SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
}
if(SUPABASE_URL && SUPABASE_ANON_KEY){
  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false, autoRefreshToken:false } });
} else {
  console.warn('Supabase config not found.');
}
</script>

<script>
(async ()=>{
  try{
    const btn = document.getElementById('btnSubmit') || document.querySelector('button#btnSubmit') || document.querySelector('button[type=button]');
    if(!btn) return;
    btn.addEventListener('click', async (e)=>{
      try{
        if(!window.supabase) return alert('Supabase ì„¤ì • í•„ìš” (config.js)');
        // session check
        const { data } = await window.supabase.auth.getSession();
        if(!data?.session) return alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.');
        const fileInput = document.getElementById('image') || document.querySelector('input[type=file]');
        const file = fileInput && fileInput.files && fileInput.files[0];
        if(!file) return alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        const fileName = Date.now() + '_' + file.name.replace(/\s+/g,'_');
        const bucket = 'product-images';
        const { data:uploadData, error:uploadErr } = await window.supabase.storage.from(bucket).upload(fileName, file);
        if(uploadErr) return alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: '+uploadErr.message);
        const { data: pu } = window.supabase.storage.from(bucket).getPublicUrl(fileName);
        const imageUrl = pu.publicUrl;
        // gather other fields
        const title = (document.getElementById('title')||document.querySelector('input[name=title]')).value.trim();
        const description = (document.getElementById('desc')||document.querySelector('textarea[name=desc]')).value.trim();
        const price_start = Number((document.getElementById('price_start')||document.querySelector('input[name=price_start]')).value) || 0;
        const price_end = Number((document.getElementById('price_end')||document.querySelector('input[name=price_end]')).value) || null;
        const { error } = await window.supabase.from('products').insert([{ title, description, price_start, price_end, images: imageUrl }]);
        if(error) return alert('DB ì €ì¥ ì‹¤íŒ¨: '+error.message);
        alert('ìƒí’ˆ ë“±ë¡ ì™„ë£Œ');
        window.location.href = 'weners_with_bids_realtime_auth.html';
      }catch(err){
        console.error(err);
        alert('ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜');
      }
    });
  }catch(e){ console.warn('create patch fail', e); }
})();
</script>
</body>
</html>
