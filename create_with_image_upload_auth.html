<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìƒí’ˆë“±ë¡ (ì´ë¯¸ì§€ ì—…ë¡œë“œ) - WeNers</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<script>
// Supabase ì´ˆê¸°í™” ë¡œì§
const SUPABASE_URL = window.SUPABASE_URL;
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
let supabase;
let currentUser = null;

if (SUPABASE_URL && SUPABASE_ANON_KEY) {
    supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: false }
    });
} else {
    console.error('Supabase ì„¤ì • (config.js)ì„ í™•ì¸í•˜ì„¸ìš”.');
}

// ----------------------------------------------------
// ğŸ”¥ ìƒí’ˆ ë“±ë¡ ë¡œì§
// ----------------------------------------------------
async function submitProduct() {
    if (!supabase) return alert('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨');
    if (!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');

    const fileInput = document.getElementById('image');
    const titleInput = document.getElementById('title');
    const priceStartInput = document.getElementById('price_start');
    const endDateInput = document.getElementById('end_date'); // ë§ˆê°ì¼ ì…ë ¥ í•„ë“œê°€ ìˆë‹¤ê³  ê°€ì •

    const file = fileInput?.files[0];
    const title = titleInput?.value.trim();
    const price_start = Number(priceStartInput?.value) || 0;
    const end_date = endDateInput?.value;

    if (!title || !price_start || !end_date) return alert('ì œëª©, ì‹œì‘ê°€, ë§ˆê°ì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    let imageUrl = '';
    if (file) {
        try {
            const fileName = currentUser.id + '/' + Date.now() + '_' + file.name.replace(/\s+/g, '_');
            const bucket = 'product-images';
            
            const { error: uploadErr } = await supabase.storage.from(bucket).upload(fileName, file);
            if (uploadErr) {
                console.error(uploadErr);
                return alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
            }
            
            // ì´ë¯¸ì§€ Public URL ê°€ì ¸ì˜¤ê¸°
            const { data: pu } = supabase.storage.from(bucket).getPublicUrl(fileName);
            imageUrl = pu.publicUrl;

        } catch (err) {
            console.error(err);
            return alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    // ê¸°íƒ€ í•„ë“œ ìˆ˜ì§‘
    const description = document.getElementById('desc')?.value.trim();
    const price_buy_now = Number(document.getElementById('price_end')?.value) || null; // ì¦‰ì‹œêµ¬ë§¤ê°€ (price_end IDë¥¼ ì‚¬ìš©)

    // Supabase 'products' í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
    const { error } = await supabase.from('products').insert([{ 
        title, 
        description, 
        price_start, 
        price_buy_now, 
        end_date,
        images: [imageUrl], // ì´ë¯¸ì§€ URLì„ ë°°ì—´ë¡œ ì €ì¥
        creator_id: currentUser.id // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
    }]);

    if(error) {
        return alert('DB ì €ì¥ ì‹¤íŒ¨: ' + error.message);
    }

    alert('ìƒí’ˆ ë“±ë¡ ì™„ë£Œ');
    window.location.href = 'index.html';
}

// ----------------------------------------------------
// ğŸ”¥ ì¸ì¦ í™•ì¸ (ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ)
// ----------------------------------------------------
async function checkAuth() {
    if (!supabase) return;
    
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session ? session.user : null;
    
    if (!currentUser) {
        alert('ìƒí’ˆ ë“±ë¡ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        location.href = 'auth_login.html';
    }
}

document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>

