<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìƒí’ˆë“±ë¡ (ì´ë¯¸ì§€ ì—…ë¡œë“œ) - WeNers</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
body { font-family: Arial; width: 400px; margin: 30px auto;}
input, textarea {width: 100%; padding: 8px; margin-bottom:10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
button { width: 100%; padding:10px; background:#0066ff;color:white; font-weight:bold; border: none; border-radius: 4px; cursor: pointer;}
</style>
</head>
<body>

<h2>ğŸ›’ ì‹ ê·œ ìƒí’ˆ ë“±ë¡</h2>
<p class="text-sm text-gray-500 mb-4">ë¡œê·¸ì¸í•´ì•¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<input id="title" placeholder="ìƒí’ˆ ì œëª©"/>
<textarea id="desc" placeholder="ì„¤ëª…"></textarea>
<input id="price_start" type="number" placeholder="ì‹œì‘ê°€ (í•„ìˆ˜)"/>
<input id="price_end" type="number" placeholder="ì¦‰ì‹œêµ¬ë§¤ê°€ (ì„ íƒ)"/>
<label for="end_date" class="text-sm text-gray-700 block mt-2">ê²½ë§¤ ë§ˆê°ì¼ì‹œ:</label>
<input id="end_date" type="datetime-local" required/>
<input id="image" type="file" class="mt-4"/>

<button onclick="submitProduct()">ğŸ“Œ ìƒí’ˆ ë“±ë¡</button>
<p><a href="index.html">â† ëª©ë¡ìœ¼ë¡œ</a></p>

<script>
// Supabase ì´ˆê¸°í™” ë¡œì§
const SUPABASE_URL_FROM_WINDOW = window.SUPABASE_URL;
const SUPABASE_ANON_KEY_FROM_WINDOW = window.SUPABASE_ANON_KEY;
let supabase;
let currentUser = null;

if (SUPABASE_URL_FROM_WINDOW && SUPABASE_ANON_KEY_FROM_WINDOW) {
    supabase = supabase.createClient(SUPABASE_URL_FROM_WINDOW, SUPABASE_ANON_KEY_FROM_WINDOW, {
        auth: { persistSession: false }
    });
} else {
    console.error('Supabase ì„¤ì • (config.js)ì„ í™•ì¸í•˜ì„¸ìš”.');
}

// ----------------------------------------------------
// ğŸ”¥ ìƒí’ˆ ë“±ë¡ ë¡œì§
// ----------------------------------------------------
async function submitProduct() {
    if (!supabase) return alert('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨');
    if (!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');

    const fileInput = document.getElementById('image');
    const title = document.getElementById('title')?.value.trim();
    const price_start = Number(document.getElementById('price_start')?.value) || 0;
    const end_date = document.getElementById('end_date')?.value;
    
    const file = fileInput?.files[0];
    
    if (!title || !price_start || !end_date) return alert('ì œëª©, ì‹œì‘ê°€, ë§ˆê°ì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    let imageUrl = '';
    if (file) {
        try {
            // íŒŒì¼ëª…: [ìœ ì €ID]/[íƒ€ì„ìŠ¤íƒ¬í”„]_[íŒŒì¼ëª…]
            const fileName = currentUser.id + '/' + Date.now() + '_' + file.name.replace(/\s+/g, '_');
            const bucket = 'product-images';
            
            const { error: uploadErr } = await supabase.storage.from(bucket).upload(fileName, file);
            if (uploadErr) {
                console.error(uploadErr);
                return alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
            }
            
            // ì´ë¯¸ì§€ Public URL ê°€ì ¸ì˜¤ê¸°
            const { data: pu } = supabase.storage.from(bucket).getPublicUrl(fileName);
            imageUrl = pu.publicUrl;

        } catch (err) {
            console.error(err);
            return alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ');
        }
    }
    
    // ê¸°íƒ€ í•„ë“œ ìˆ˜ì§‘
    const description = document.getElementById('desc')?.value.trim();
    const price_buy_now = Number(document.getElementById('price_end')?.value) || null; 

    // Supabase 'products' í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
    const { error } = await supabase.from('products').insert([{ 
        title, 
        description, 
        price_start, 
        price_buy_now, 
        end_date,
        images: imageUrl ? [imageUrl] : [], // ì´ë¯¸ì§€ URLì´ ìˆìœ¼ë©´ ë°°ì—´ë¡œ ì €ì¥
        creator_id: currentUser.id 
    }]);

    if(error) {
        return alert('DB ì €ì¥ ì‹¤íŒ¨: ' + error.message);
    }

    alert('ìƒí’ˆ ë“±ë¡ ì™„ë£Œ');
    window.location.href = 'index.html';
}

// ----------------------------------------------------
// ğŸ”¥ ì¸ì¦ í™•ì¸ (ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ)
// ----------------------------------------------------
async function checkAuth() {
    if (!supabase) return;
    
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session ? session.user : null;
    
    if (!currentUser) {
        alert('ìƒí’ˆ ë“±ë¡ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        location.href = 'auth_login.html';
    }
}

document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>
