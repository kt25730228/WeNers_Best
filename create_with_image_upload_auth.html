<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ìƒí’ˆë“±ë¡ (ì´ë¯¸ì§€ ì—…ë¡œë“œ) - WeNers</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <style>body{font-family:Arial;width:400px;margin:30px auto}input,textarea{width:100%;padding:8px;margin-bottom:10px}button{width:100%;padding:10px;background:#0066ff;color:white;font-weight:bold}</style>
</head>
<body>
  <h2>ğŸ›’ ì‹ ê·œ ìƒí’ˆ ë“±ë¡</h2>

  <input id="title" placeholder="ìƒí’ˆ ì œëª©"/>
  <textarea id="desc" placeholder="ì„¤ëª…"></textarea>
  <input id="price_start" type="number" placeholder="ì‹œì‘ê°€"/>
  <input id="price_end" type="number" placeholder="ì¦‰ì‹œêµ¬ë§¤ê°€(ì„ íƒ)"/>
  <input id="image" type="file" accept="image/*"/>

  <button id="btnSubmit">ğŸ“Œ ìƒí’ˆ ë“±ë¡</button>
  <p><a href="weners_with_bids_realtime_auth.html">â† ëª©ë¡ìœ¼ë¡œ</a></p>

<script>
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
  alert('config.js ì„¤ì • í•„ìš”');
}
const supabase = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

(async function checkLogin(){
  const { data } = await supabase.auth.getSession();
  if(!data?.session){
    alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.');
    location.href = 'auth_login.html';
  }
})();

document.getElementById('btnSubmit').addEventListener('click', submitProduct);

async function submitProduct(){
  const fileInput = document.getElementById("image");
  const file = fileInput.files[0];
  if(!file) return alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");

  const fileName = `${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
  const bucket = 'product-images';

  try{
    // ì—…ë¡œë“œ
    const { data: uploadData, error: uploadErr } = await supabase.storage
      .from(bucket)
      .upload(fileName, file, { upsert: false });

    if(uploadErr){
      console.error('uploadErr', uploadErr);
      return alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadErr.message);
    }

    // ê³µê°œ URL ì–»ê¸° (bucketì´ public ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨)
    const { data: publicUrlData } = supabase.storage.from(bucket).getPublicUrl(fileName);
    const imageUrl = publicUrlData.publicUrl;

    // DB ì €ì¥
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('desc').value.trim();
    const price_start = Number(document.getElementById('price_start').value) || 0;
    const price_end = Number(document.getElementById('price_end').value) || null;

    const { error } = await supabase.from('products').insert([{
      title,
      description,
      price_start,
      price_end,
      images: imageUrl,
      created_at: new Date(),
    }]);

    if(error) {
      console.error('db insert err', error);
      return alert('DB ì €ì¥ ì˜¤ë¥˜: ' + error.message);
    }

    alert('ğŸ‰ ìƒí’ˆ ë“±ë¡ ì™„ë£Œ!');
    location.href = 'weners_with_bids_realtime_auth.html';
  }catch(err){
    console.error(err);
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” í™•ì¸');
  }
}
</script>
</body>
</html>
