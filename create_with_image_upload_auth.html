<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상품 등록 | WeNers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script> 

    <style>
        body { font-family: 'Malgun Gothic', '맑은 고딕', sans-serif; background-color: #F8F9FB; }
        .main-button { background-color: #00a0e9; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="product-registration-container" class="w-full max-w-2xl bg-white p-8 rounded-xl shadow-2xl mt-10" style="display: none;">
        <h2 class="text-3xl font-bold text-gray-800 text-center mb-8" style="color: #007bff;">새 경매 상품 등록</h2>

        <form id="productForm" class="space-y-6">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700">상품명</label>
                <input id="title" type="text" placeholder="경매 상품명 입력" required
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <div>
                <label for="price_start" class="block text-sm font-medium text-gray-700">경매 시작 가격 (원)</label>
                <input id="price_start" type="number" placeholder="최소 시작 가격" required min="1000"
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <div>
                <label for="end_date" class="block text-sm font-medium text-gray-700">경매 마감 일시</label>
                <input id="end_date" type="datetime-local" required
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">상품 설명</label>
                <textarea id="description" rows="4" placeholder="상세 정보를 입력하세요" required
                          class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <div>
                <label for="images" class="block text-sm font-medium text-gray-700">상품 이미지 (최대 5개)</label>
                <input id="images" type="file" multiple accept="image/*"
                       class="mt-1 w-full border border-gray-300 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>

            <button type="submit" class="w-full p-3 main-button text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out">
                경매 등록하기
            </button>
        </form>
    </div>

    <div id="loading-indicator" class="mt-20 text-lg text-gray-500">
        인증 상태를 확인 중입니다...
    </div>

<script>
    // ⭐ 수정된 부분: 변수 이름 통일
    let supabaseClient = null;
    let currentUser = null;

    function initializeSupabase() {
        const url = window.SUPABASE_URL;
        const key = window.SUPABASE_ANON_KEY;
        
        if (url && key && window.supabase && typeof window.supabase.createClient === 'function') {
            supabaseClient = window.supabase.createClient(url, key, { 
                auth: { persistSession: true, autoRefreshToken: true } 
            });
            // window.supabase = supabaseClient; // 제거
            return true;
        }
        return false;
    }

    async function checkAuthAndProtect() {
        const loadingEl = document.getElementById('loading-indicator');
        const containerEl = document.getElementById('product-registration-container');
        
        if (!initializeSupabase()) {
             loadingEl.textContent = "시스템 초기화 오류. config.js를 확인하세요.";
             return;
        }

        const { data: { session }, error } = await supabaseClient.auth.getSession();

        if (error || !session) {
            console.log("보호된 페이지 접근: 세션 없음.");
            loadingEl.textContent = "로그인이 필요합니다. 로그인 페이지로 이동합니다...";
            setTimeout(() => {
                window.location.href = "auth_login.html";
            }, 1000); 
        } else {
            currentUser = session.user;
            console.log("인증 성공. 상품 등록 페이지 로드:", currentUser.email);
            
            loadingEl.style.display = 'none';
            containerEl.style.display = 'block';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkAuthAndProtect();
        const form = document.getElementById('productForm');
        form.addEventListener('submit', handleProductSubmit);
    });
    
    // 상품 등록 처리 함수
    async function handleProductSubmit(e) {
        e.preventDefault();
        
        if (!currentUser || !supabaseClient) {
            alert('인증 상태를 확인하지 못했습니다. 다시 로그인해주세요.');
            return;
        }
        
        const title = document.getElementById('title').value.trim();
        const priceStart = Number(document.getElementById('price_start').value);
        const endDate = document.getElementById('end_date').value;
        const description = document.getElementById('description').value.trim();
        const files = document.getElementById('images').files;
        
        if (!title || priceStart <= 0 || !endDate || !description) {
            return alert('모든 필수 항목을 입력해주세요.');
        }

        try {
            // ⭐ 이미지 업로드 로직 (간결성을 위해 스토리지 업로드는 생략하고 DB 등록만 예시)
            const imageUrls = []; 
            if (files.length > 0) {
                 // 실제 구현 시 여기에 Supabase Storage 업로드 로직을 추가해야 합니다.
                 // 지금은 파일 목록을 이미지 URL 배열로 가정합니다.
                 imageUrls.push('https://via.placeholder.com/600x400.png?text=' + encodeURIComponent(title));
            }

            const { data, error } = await supabaseClient
                .from('products')
                .insert([{
                    title: title,
                    price_start: priceStart,
                    end_date: endDate,
                    description: description,
                    
                    // ⭐ 최종 수정된 부분: seller_id와 creator_id에 사용자 ID 할당
                    seller_id: currentUser.id, 
                    creator_id: currentUser.id, 
                    
                    images: imageUrls, 
                    is_sold: false
                }])
                .select()
                .single();

            if (error) throw error;
            
            alert(`상품 등록 성공! (ID: ${data.id})`);
            // ⭐ 최종 수정된 부분: 등록 후 해당 상세 페이지로 이동
            window.location.href = `detail.html?id=${data.id}`; 

        } catch (error) {
            console.error('상품 등록 오류:', error.message);
            alert('상품 등록 중 오류가 발생했습니다: ' + error.message);
        }
    }
</script>
</body>
</html>
