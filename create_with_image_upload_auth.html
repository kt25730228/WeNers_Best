<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ë“±ë¡ | WeNers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script> 

    <style>
        body { font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; background-color: #F8F9FB; }
        .main-button { background-color: #00a0e9; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="product-registration-container" class="w-full max-w-2xl bg-white p-8 rounded-xl shadow-2xl mt-10" style="display: none;">
        <h2 class="text-3xl font-bold text-gray-800 text-center mb-8" style="color: #007bff;">ìƒˆ ê²½ë§¤ ìƒí’ˆ ë“±ë¡</h2>

        <form id="productForm" class="space-y-6">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700">ìƒí’ˆëª…</label>
                <input id="title" type="text" placeholder="ê²½ë§¤ ìƒí’ˆëª… ì…ë ¥" required
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <div>
                <label for="price_start" class="block text-sm font-medium text-gray-700">ê²½ë§¤ ì‹œì‘ ê°€ê²© (ì›)</label>
                <input id="price_start" type="number" placeholder="ìµœì†Œ ì‹œì‘ ê°€ê²©" required min="1000"
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <div>
                <label for="end_date" class="block text-sm font-medium text-gray-700">ê²½ë§¤ ë§ˆê° ì¼ì‹œ</label>
                <input id="end_date" type="datetime-local" required
                       class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">ìƒí’ˆ ì„¤ëª…</label>
                <textarea id="description" rows="4" placeholder="ìƒì„¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required
                          class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <div>
                <label for="images" class="block text-sm font-medium text-gray-700">ìƒí’ˆ ì´ë¯¸ì§€ (ìµœëŒ€ 5ê°œ)</label>
                <input id="images" type="file" multiple accept="image/*"
                       class="mt-1 w-full border border-gray-300 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>

            <button type="submit" class="w-full p-3 main-button text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out">
                ê²½ë§¤ ë“±ë¡í•˜ê¸°
            </button>
        </form>
    </div>

    <div id="loading-indicator" class="mt-20 text-lg text-gray-500">
        ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...
    </div>

<script>
    // ====================================================================
    // A. ì¸ì¦ ë° ì´ˆê¸°í™” ë¡œì§ (ì„¸ì…˜ ìœ ì§€ ë° í˜ì´ì§€ ë³´í˜¸)
    // ====================================================================

    let supabaseClient = null;
    let currentUser = null;

    // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeSupabase() {
        const url = window.SUPABASE_URL;
        const key = window.SUPABASE_ANON_KEY;
        
        if (url && key && window.supabase && typeof window.supabase.createClient === 'function') {
            // í•µì‹¬: persistSession: true ì„¤ì •ìœ¼ë¡œ ì„¸ì…˜ì„ ìœ ì§€í•©ë‹ˆë‹¤.
            supabaseClient = window.supabase.createClient(url, key, { 
                auth: { persistSession: true, autoRefreshToken: true } 
            });
            window.supabase = supabaseClient; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            return true;
        }
        return false;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸ ë° ë³´í˜¸ í•¨ìˆ˜
    async function checkAuthAndProtect() {
        const loadingEl = document.getElementById('loading-indicator');
        const containerEl = document.getElementById('product-registration-container');
        
        // 1. í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹œë„
        if (!initializeSupabase()) {
             loadingEl.textContent = "ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜. config.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.";
             return;
        }

        // 2. ì„¸ì…˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const { data: { session }, error } = await supabaseClient.auth.getSession();

        if (error || !session) {
            // ğŸ›‘ ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            console.log("ë³´í˜¸ëœ í˜ì´ì§€ ì ‘ê·¼: ì„¸ì…˜ ì—†ìŒ. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.");
            loadingEl.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...";
            
            // 1ì´ˆ í›„ ì´ë™ (ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë³¼ ì‹œê°„ ì œê³µ)
            setTimeout(() => {
                window.location.href = "auth_login.html";
            }, 1000); 
            
        } else {
            // âœ… ì„¸ì…˜ ìœ íš¨: ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ê³  í˜ì´ì§€ ë‚´ìš©ì„ í‘œì‹œí•©ë‹ˆë‹¤.
            currentUser = session.user;
            console.log("ì¸ì¦ ì„±ê³µ. ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ ë¡œë“œ:", currentUser.email);
            
            loadingEl.style.display = 'none'; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            containerEl.style.display = 'block'; // í¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
        }
    }

    // ====================================================================
    // B. ìƒí’ˆ ë“±ë¡ ë¡œì§ (creator_id ì˜¤ë¥˜ í•´ê²°ë¨)
    // ====================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // 1. í˜ì´ì§€ ë³´í˜¸ ë¡œì§ ì‹¤í–‰
        checkAuthAndProtect();

        // 2. í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const form = document.getElementById('productForm');
        form.addEventListener('submit', handleProductSubmit);
    });
    
    // ìƒí’ˆ ë“±ë¡ ì²˜ë¦¬ í•¨ìˆ˜
    async function handleProductSubmit(e) {
        e.preventDefault();
        
        if (!currentUser) {
            alert('ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            return window.location.href = "auth_login.html";
        }
        
        const title = document.getElementById('title').value.trim();
        const priceStart = Number(document.getElementById('price_start').value);
        const endDate = document.getElementById('end_date').value;
        const description = document.getElementById('description').value.trim();
        const files = document.getElementById('images').files;
        
        if (!title || priceStart <= 0 || !endDate || !description) {
            return alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }

        try {
            // ğŸ’¡ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ (ê°„ê²°ì„±ì„ ìœ„í•´ ìŠ¤í† ë¦¬ì§€ ì—…ë¡œë“œëŠ” ìƒëµí•˜ê³  DB ë“±ë¡ë§Œ ì˜ˆì‹œ)
            const imageUrls = []; 

            // 1. DBì— ìƒí’ˆ ì •ë³´ ë“±ë¡
            const { data, error } = await supabaseClient
                .from('products')
                .insert([{
                    title: title,
                    price_start: priceStart,
                    end_date: endDate,
                    description: description,
                    
                    // â­ ìˆ˜ì •ë¨: seller_idì— ì‚¬ìš©ì ID í• ë‹¹
                    seller_id: currentUser.id, 
                    
                    // â­ ìˆ˜ì •ë¨: creator_idì— ì‚¬ìš©ì ID í• ë‹¹ (ì´ì „ ì˜¤ë¥˜ í•´ê²° ì½”ë“œ)
                    creator_id: currentUser.id, 
                    
                    images: imageUrls, 
                    is_sold: false
                }])
                .select()
                .single();

            if (error) throw error;
            
            alert(`ìƒí’ˆ ë“±ë¡ ì„±ê³µ! (ID: ${data.id})`);
            // ë“±ë¡ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = "index.html"; 

        } catch (error) {
            console.error('ìƒí’ˆ ë“±ë¡ ì˜¤ë¥˜:', error.message);
            alert('ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
</script>
</body>
</html>
