<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>WeNers ì‹¤ì‹œê°„ ì…ì°°</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
body { font-family: Arial; width:700px; margin:30px auto;}
.item {border-bottom:1px solid #ddd; padding:10px 0;}
.item h3 {margin:5px 0;}
</style>
</head>
<body>

<h2>ğŸ”· ìœ„ë„ˆìŠ¤ ì‹¤ì‹œê°„ ê²½ë§¤ (ë¡œê·¸ì¸)</h2>
<button onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
<button onclick="location.href='create_with_image_upload_auth.html'">ğŸ“Œ ìƒí’ˆ ë“±ë¡</button>
<hr>
<div id="list"></div>

<script>
// ğŸ”¥ Supabase ì—°ê²° â€” config.js KEY ì ìš©
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ë¡œê·¸ì¸ ì„¸ì…˜ í™•ì¸
supabase.auth.getSession().then(({data})=>{
 if(!data.session) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤"); location.href="auth_login.html"; }
 loadProducts();
 subscribeRealtime();
});

// ğŸ”¥ ì‹¤ì‹œê°„ ì…ì°° ë°˜ì˜
function subscribeRealtime(){
 supabase.channel("realtime:bids")
 .on("postgres_changes",{ event:"INSERT", schema:"public", table:"bids" }, loadProducts)
 .subscribe();
}

// ìƒí’ˆ ëª©ë¡ ë¡œë“œ
async function loadProducts(){
 const { data, error } = await supabase.from("products").select("*");
 if(error) return alert("ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

 list.innerHTML="";

 data.forEach(p=>{
    list.innerHTML += `
    <div class="item">
    <h3>${p.title}</h3>
    <p>${p.description||""}</p>
    <img src="${p.images}" width="200"><br><br>

    ğŸ’° ì‹œì‘ê°€: ${p.price_start}ì› <br>
    âš¡ ì¦‰ì‹œêµ¬ë§¤: ${p.price_end||"-"}<br><br>

    <input id="bid_${p.id}" type="number" placeholder="ì…ì°°ê°€ ì…ë ¥"/>
    <button onclick="bid('${p.id}')">ì…ì°°</button>
    </div>`;
 });
}

// ì…ì°° ê¸°ëŠ¥
async function bid(id){
 const price = Number(document.getElementById(`bid_${id}`).value);
 const user = (await supabase.auth.getUser()).data.user;

 await supabase.from("bids").insert({
    product_id: id,
    price: price,
    bidder: user.email
 });

 alert("ì…ì°° ì™„ë£Œ!");
}

// ë¡œê·¸ì•„ì›ƒ
function logout(){
 supabase.auth.signOut();
 alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
 location.href="auth_login.html";
}
</script>

<script type="module">
// Minimal Supabase client init (persistSession:false to avoid auto login restore)
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
let SUPABASE_URL, SUPABASE_ANON_KEY;
try{
  const mod = await import('./config.js').catch(()=>null);
  if(mod && (mod.SUPABASE_URL || mod.default?.SUPABASE_URL)){
    SUPABASE_URL = mod.SUPABASE_URL || mod.default?.SUPABASE_URL;
    SUPABASE_ANON_KEY = mod.SUPABASE_ANON_KEY || mod.default?.SUPABASE_ANON_KEY;
  } else {
    SUPABASE_URL = window.SUPABASE_URL;
    SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
  }
}catch(e){
  SUPABASE_URL = window.SUPABASE_URL;
  SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
}
if(SUPABASE_URL && SUPABASE_ANON_KEY){
  window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false, autoRefreshToken:false } });
} else {
  console.warn('Supabase config not found.');
}
</script>

<script>
(async ()=>{
  try{
    if(!window.supabase) return;
    // simple load products if productList id exists
    const listEl = document.getElementById('list') || document.getElementById('productList');
    if(listEl){
      try{
        const { data, error } = await window.supabase.from('products').select('*').order('created_at',{ascending:false}).limit(50);
        if(error){ listEl.innerHTML = '<p>ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>'; console.error(error); }
        else {
          listEl.innerHTML = '';
          data.forEach(p=>{
            const div = document.createElement('div');
            div.className='item';
            div.innerHTML = `<h3>${p.title}</h3><p>${p.description||''}</p>${p.images?'<img src="'+p.images+'" width="200">':''}`;
            listEl.appendChild(div);
          });
        }
      }catch(e){console.error(e);}
    }
    // subscribe to bids
    try{
      window.supabase.channel('realtime-bids').on('postgres_changes',{event:'INSERT',schema:'public',table:'bids'},payload=>{
        console.log('new bid', payload);
        // reload simple
        if(listEl) (async ()=>{ const r=await window.supabase.from('products').select('*').order('created_at',{ascending:false}).limit(50); if(r.data) { listEl.innerHTML=''; r.data.forEach(p=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<h3>${p.title}</h3><p>${p.description||''}</p>${p.images?'<img src="'+p.images+'" width="200">':''}`; listEl.appendChild(d); }); } })();
      }).subscribe();
    }catch(e){console.warn('subscribe fail', e);}
  }catch(e){ console.warn('weners patch fail', e); }
})();
</script>
</body>
</html>
