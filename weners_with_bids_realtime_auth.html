<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>WeNers ì‹¤ì‹œê°„ ì…ì°°</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <style>body{font-family:Arial;width:700px;margin:30px auto}.item{border-bottom:1px solid #ddd;padding:10px 0}.item h3{margin:5px 0}</style>
</head>
<body>
  <h2>ğŸ”· ìœ„ë„ˆìŠ¤ ì‹¤ì‹œê°„ ê²½ë§¤</h2>
  <div id="authArea"></div>
  <button id="btnCreate" style="display:none" onclick="location.href='create_with_image_upload_auth.html'">ğŸ“Œ ìƒí’ˆ ë“±ë¡</button>
  <hr/>
  <div id="list"></div>

<script>
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
  alert('config.js ì„¤ì • í•„ìš”');
}
const supabase = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

async function init(){
  const { data } = await supabase.auth.getSession();
  const session = data?.session || null;

  const authArea = document.getElementById('authArea');
  authArea.innerHTML = '';
  if(!session){
    authArea.innerHTML = `<a href="auth_login.html">ë¡œê·¸ì¸</a> | <a href="auth_signup.html">íšŒì›ê°€ì…</a>`;
  } else {
    const user = session.user;
    authArea.innerHTML = `<strong>${user.email}</strong> <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>`;
    document.getElementById('btnCreate').style.display = 'inline-block';
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      location.reload();
    });
  }

  await loadProducts();
  subscribeRealtime();
}

async function loadProducts(){
  try{
    const { data, error } = await supabase.from('products').select('*').order('created_at', {ascending:false});
    if(error){
      console.error('loadProducts err', error);
      return alert('ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
    }
    const list = document.getElementById('list');
    list.innerHTML = '';
    (data || []).forEach(p=>{
      const html = `
        <div class="item">
          <h3>${escapeHtml(p.title)}</h3>
          <p>${escapeHtml(p.description || '')}</p>
          ${p.images ? `<img src="${p.images}" width="200"><br>` : ''}
          ğŸ’° ì‹œì‘ê°€: ${p.price_start}ì› <br>
          âš¡ ì¦‰ì‹œêµ¬ë§¤: ${p.price_end||"-"}<br><br>
          <input id="bid_${p.id}" type="number" placeholder="ì…ì°°ê°€ ì…ë ¥">
          <button onclick="bid('${p.id}')">ì…ì°°</button>
        </div>`;
      list.insertAdjacentHTML('beforeend', html);
    });
  }catch(err){
    console.error(err);
    alert('ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜');
  }
}

function subscribeRealtime(){
  supabase.channel('realtime:bids')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bids' }, payload=>{
      console.log('realtime payload', payload);
      loadProducts();
    }).subscribe();
}

async function bid(id){
  const price = Number(document.getElementById(`bid_${id}`).value);
  if(!price) return alert('ì…ì°°ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if(!user) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.');

  const { error } = await supabase.from('bids').insert([{
    product_id: id,
    price,
    bidder: user.email,
    created_at: new Date()
  }]);
  if(error){
    console.error('bid err', error);
    return alert('ì…ì°° ì‹¤íŒ¨: ' + error.message);
  }
  alert('ì…ì°° ì™„ë£Œ!');
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

init();
</script>
</body>
</html>
