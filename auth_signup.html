<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>회원가입</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
/* 이미지와 유사한 배경 및 박스 스타일 */
body { font-family: system-ui, -apple-system, sans-serif; background-color: #f0f8ff; }
.signup-box { @apply w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl; }
/* 이미지와 유사한 인풋 필드 스타일 */
.input-style { @apply w-full p-3 border border-gray-200 rounded-lg placeholder-gray-400 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 }
/* 이미지와 유사한 버튼 스타일 */
.main-button { @apply w-full p-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition duration-150 ease-in-out }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="signup-box">
    <h2 class="text-3xl font-bold text-gray-800 text-center mb-8" style="color:#007bff;">회원가입</h2>

    <form id="signupForm" onsubmit="signup(event)" class="space-y-4">
        
        <div>
            <input id="name" type="text" placeholder="성명" required class="input-style"/>
        </div>
        
        <div>
            <div class="flex space-x-2">
                <input id="email" type="email" placeholder="이메일" required
                       oninput="resetEmailStatus()"
                       class="flex-grow input-style"/>
                <button type="button" id="checkDuplicateBtn" onclick="checkEmailDuplication()"
                        class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition duration-150 ease-in-out text-sm disabled:bg-gray-200 disabled:text-gray-500">
                    중복확인
                </button>
            </div>
            <p id="emailStatus" class="mt-1 text-sm text-red-500">중복 확인이 필요합니다.</p>
        </div>
        
        <div class="flex space-x-2">
            <input id="birthYear" type="number" placeholder="출생연도(yyyy)" required maxlength="4" 
                   oninput="this.value=this.value.slice(0,this.maxLength)"
                   class="w-1/3 input-style text-center"/>
            <input id="birthMonth" type="number" placeholder="월(mm)" required maxlength="2" 
                   oninput="this.value=this.value.slice(0,this.maxLength)"
                   class="w-1/3 input-style text-center"/>
            <input id="birthDay" type="number" placeholder="일(dd)" required maxlength="2" 
                   oninput="this.value=this.value.slice(0,this.maxLength)"
                   class="w-1/3 input-style text-center"/>
        </div>

        <div>
            <input id="phone_number" type="tel" placeholder="휴대폰 번호 (숫자만 입력)" required maxlength="13" 
                   oninput="formatPhoneNumber(this)"
                   class="input-style"/>
        </div>

        <div>
            <select id="company" required class="input-style bg-white appearance-none pr-8">
                <option value="" disabled selected>회사 선택</option>
                <option value="Webcash">웹케시</option>
                <option value="Coocon">쿠콘</option>
                <option value="Bizplay">비즈플레이</option>
                <option value="Biplepay">비플페이</option>
            </select>
        </div>

        <div>
            <input id="department" type="text" placeholder="소속부서" required class="input-style"/>
        </div>
        
        <div>
            <input id="password" type="password" placeholder="비밀번호" required minlength="10" class="input-style"/>
            <p id="passwordHint" class="mt-1 text-xs text-gray-500 hidden">영문, 숫자, 특수문자(!@#$%)를 포함하여 10자리 이상이어야 합니다.</p>
        </div>

        <div>
            <input id="passwordConfirm" type="password" placeholder="비밀번호 확인" required minlength="10" class="input-style"/>
        </div>

        <button type="submit" id="signupBtn" class="main-button mt-6">
            가입하기
        </button>
    </form>
    
    <p class="text-center mt-4 text-sm text-gray-600">
        <a href="auth_login.html" class="hover:text-blue-500">이미 계정이 있나요?</a>
    </p>
</div>

<script>
let supabase = null; 
let isEmailChecked = false;

function getSupabaseClient() {
    // Supabase 클라이언트 인스턴스 초기화 로직 (이전과 동일)
    if (window.supabase && typeof window.supabase.auth !== 'undefined') return window.supabase;

    const url = window.SUPABASE_URL;
    const key = window.SUPABASE_ANON_KEY;
    
    if (url && key && window.supabase && typeof window.supabase.createClient === 'function') {
        window.supabase = window.supabase.createClient(url, key, { auth: { persistSession: false, autoRefreshToken: false } });
        return window.supabase;
    }
    return null;
}

document.addEventListener('DOMContentLoaded', () => {
    supabase = getSupabaseClient();
});

// --- 유틸리티 함수 ---

// 휴대폰 번호 하이픈 포맷팅 (000-0000-0000)
function formatPhoneNumber(input) {
    let num = input.value.replace(/[^0-9]/g, ''); // 숫자만 남김
    
    if (num.length > 11) num = num.slice(0, 11); // 11자리 초과 방지
    
    // 자동 하이픈 삽입 (11자리일 경우)
    if (num.length === 11) {
        input.value = num.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    } else {
        input.value = num; // 11자리가 아닐 때는 하이픈 없이 숫자만 유지
    }
}

function resetEmailStatus() {
    isEmailChecked = false;
    document.getElementById('emailStatus').textContent = '중복 확인이 필요합니다.';
    document.getElementById('emailStatus').className = 'mt-1 text-sm text-red-500';
    document.getElementById('checkDuplicateBtn').disabled = false;
    document.getElementById('email').readOnly = false;
}

async function checkEmailDuplication() {
    const emailEl = document.getElementById('email');
    const email = emailEl.value.trim();
    const statusEl = document.getElementById('emailStatus');
    const checkBtn = document.getElementById('checkDuplicateBtn');

    if (!email || !email.includes('@')) {
        return alert('유효한 이메일 주소를 입력해 주세요.');
    }
    
    checkBtn.disabled = true;
    statusEl.textContent = '중복 확인 중...';
    statusEl.className = 'mt-1 text-sm text-blue-500';

    await new Promise(resolve => setTimeout(resolve, 1500)); 

    // 데모: 항상 사용 가능하다고 가정하고 성공 상태로 변경
    isEmailChecked = true;
    statusEl.textContent = '사용 가능한 이메일입니다.';
    statusEl.className = 'mt-1 text-sm text-green-600 font-bold';
    emailEl.readOnly = true; 
    checkBtn.disabled = true; 
}


// --- 메인 회원가입 로직 ---
async function signup(e){
    e.preventDefault();
    
    const client = getSupabaseClient();
    if(!client) return alert('Supabase 클라이언트 초기화 실패.');

    // 1. 중복 확인 플래그 검사
    if (!isEmailChecked) {
        return alert('이메일 중복 확인을 먼저 완료해 주세요.');
    }

    // 2. 값 수집 및 유효성 검사
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('passwordConfirm').value;
    const phone_number_formatted = document.getElementById('phone_number').value.trim();
    const company = document.getElementById('company').value;
    const department = document.getElementById('department').value.trim();
    
    const birthYear = document.getElementById('birthYear').value.trim();
    const birthMonth = document.getElementById('birthMonth').value.trim();
    const birthDay = document.getElementById('birthDay').value.trim();

    // 2.1. 필수 항목 검사 (HTML required로 대부분 처리되지만 로직 내에서 다시 체크)
    if (!name || !company || !department) {
        return alert('모든 필수 항목을 입력하거나 선택해 주세요.');
    }
    
    // 2.2. 비밀번호 일치 및 복잡성 검사
    if (password !== passwordConfirm) {
        return alert('비밀번호와 비밀번호 확인이 일치하지 않습니다.');
    }
    // 특수문자: [!@#$%], 영문: [A-Za-z], 숫자: [0-9], 길이: {10,} 이상
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%])[A-Za-z\d!@#$%]{10,}$/;
    if (!passwordRegex.test(password)) {
        return alert('비밀번호는 영문, 숫자, 특수문자(!@#$%)를 포함하여 10자리 이상이어야 합니다.');
    }

    // 2.3. 출생년월일 검사 및 합산
    if (birthYear.length !== 4 || birthMonth.length !== 2 || birthDay.length !== 2) {
        return alert('출생년월일을 YYYY, MM, DD 형식(각각 4, 2, 2자리 숫자)으로 정확히 입력해 주세요.');
    }
    const birthday = `${birthYear}-${birthMonth}-${birthDay}`;
    if (new Date(birthday).toString() === 'Invalid Date') {
        return alert('유효하지 않은 날짜입니다. 월/일을 다시 확인해 주세요.');
    }

    // 2.4. 휴대폰 번호 포맷 및 길이 검사 (하이픈 제거 후 11자리 확인)
    const phone_number = phone_number_formatted.replace(/-/g, '');
    if (phone_number.length !== 11) {
        return alert('휴대폰 번호 11자리를 정확히 입력해 주세요. (예: 01012345678)');
    }


    // 3. Supabase 회원가입 실행
    const { error } = await client.auth.signUp({
        email: email,
        password: password,
        options: {
            data: {
                // 이미지 항목 추가 및 순서 조정
                name: name,
                birthday: birthday,
                phone_number: phone_number,
                company: company,
                department: department
            }
        }
    });

    if(error) {
        console.error("회원가입 오류:", error);
        let userMessage = "회원가입 실패: " + error.message;
        if (error.message.includes('User already registered')) {
            userMessage = "이미 가입된 이메일 주소입니다. 로그인을 시도하세요.";
        }
        // 에러 발생 시 UI 상태 초기화
        resetEmailStatus(); 
        document.getElementById('email').readOnly = false;
        
        return alert(userMessage);
    }
    
    alert("회원가입 성공! 이메일 확인이 필요할 수 있습니다. 로그인 페이지로 이동합니다.");
    location.href="auth_login.html";
}
</script>
</body>
</html>
