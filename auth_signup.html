<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>회원가입 | WeNers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
/* 기본 폰트 설정 */
body { font-family: system-ui, -apple-system, sans-serif; }
</style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl">
    <h2 class="text-3xl font-bold text-gray-800 text-center mb-8">회원가입</h2>

    <form id="signupForm" onsubmit="signup(event)" class="space-y-4">
        
        <div>
            <label for="email" class="block text-sm font-medium text-gray-700">이메일 주소 (아이디)</label>
            <div class="flex space-x-2">
                <input id="email" type="email" placeholder="사용할 이메일 입력" required
                       oninput="resetEmailStatus()"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
                <button type="button" id="checkDuplicateBtn" onclick="checkEmailDuplication()"
                        class="px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out text-sm disabled:bg-gray-400">
                    중복 확인
                </button>
            </div>
            <p id="emailStatus" class="mt-1 text-sm text-red-500">중복 확인이 필요합니다.</p>
        </div>
        
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700">비밀번호</label>
            <input id="password" type="password" placeholder="6자리 이상 비밀번호 입력" required minlength="6"
                   class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
        </div>

        <div>
            <label for="phone_number" class="block text-sm font-medium text-gray-700">휴대폰 번호</label>
            <input id="phone_number" type="tel" placeholder="예: 010-1234-5678" required
                   class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
        </div>

        <div>
            <label for="company" class="block text-sm font-medium text-gray-700">소속 회사 (선택)</label>
            <select id="company" onchange="toggleCompanyOther()"
                    class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500">
                <option value="">-- 회사 선택 (선택 사항) --</option>
                <option value="Webcash">웹케시</option>
                <option value="Coocon">쿠콘</option>
                <option value="Bizplay">비즈플레이</option>
                <option value="Biplepay">비플페이</option>
                <option value="Other">기타 (직접 입력)</option>
            </select>
            <input id="companyOther" type="text" placeholder="회사명 직접 입력" style="display: none;"
                   class="mt-2 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"/>
        </div>

        <button type="submit" id="signupBtn" 
                class="w-full p-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 ease-in-out">
            회원가입 완료
        </button>
    </form>
    
    <p class="text-center mt-6 text-sm">
        이미 계정이 있으신가요? 
        <a href="auth_login.html" class="text-blue-500 hover:text-blue-700 font-medium">로그인하기</a>
    </p>
</div>

<script>
let supabase = null; 
let isEmailChecked = false; // 이메일 중복 확인 플래그

// config.js의 전역 변수에서 Supabase 클라이언트 인스턴스를 가져오거나 생성합니다.
function getSupabaseClient() {
    if (window.supabase) return window.supabase;

    const url = window.SUPABASE_URL;
    const key = window.SUPABASE_ANON_KEY;
    
    if (url && key && window.supabase && typeof window.supabase.createClient === 'function') {
        window.supabase = window.supabase.createClient(url, key, { auth: { persistSession: false, autoRefreshToken: false } });
        return window.supabase;
    }
    return null;
}

document.addEventListener('DOMContentLoaded', () => {
    supabase = getSupabaseClient();
});

// 이메일 입력 시 중복 확인 상태 초기화
function resetEmailStatus() {
    isEmailChecked = false;
    document.getElementById('emailStatus').textContent = '중복 확인이 필요합니다.';
    document.getElementById('emailStatus').className = 'mt-1 text-sm text-red-500';
    document.getElementById('checkDuplicateBtn').disabled = false;
    document.getElementById('email').readOnly = false;
}

// 이메일 중복 확인 로직 (데모 목적상 로직 단순화)
async function checkEmailDuplication() {
    const emailEl = document.getElementById('email');
    const email = emailEl.value.trim();
    const statusEl = document.getElementById('emailStatus');
    const checkBtn = document.getElementById('checkDuplicateBtn');

    if (!email || !email.includes('@')) {
        return alert('유효한 이메일 주소를 입력해 주세요.');
    }
    
    // Supabase가 실제 중복 확인 API를 제공하지 않으므로, UI/UX 흐름만 구현합니다.
    
    checkBtn.disabled = true;
    statusEl.textContent = '중복 확인 중...';
    statusEl.className = 'mt-1 text-sm text-blue-500';

    // 2초 딜레이 시뮬레이션
    await new Promise(resolve => setTimeout(resolve, 2000)); 

    // 데모: 항상 사용 가능하다고 가정하고 성공 상태로 변경
    isEmailChecked = true;
    statusEl.textContent = '사용 가능한 이메일 주소입니다.';
    statusEl.className = 'mt-1 text-sm text-green-600 font-bold';
    emailEl.readOnly = true; // 확인 완료 후 수정 불가
    checkBtn.disabled = true; 
}

// '기타' 선택 시 직접 입력 필드 표시/숨김
function toggleCompanyOther() {
    const companySelect = document.getElementById('company');
    const companyOtherInput = document.getElementById('companyOther');
    
    if (companySelect.value === 'Other') {
        companyOtherInput.style.display = 'block';
        companyOtherInput.required = true;
    } else {
        companyOtherInput.style.display = 'none';
        companyOtherInput.required = false;
        companyOtherInput.value = ''; 
    }
}


async function signup(e){
    e.preventDefault();
    
    const client = getSupabaseClient();
    if(!client) return alert('Supabase 클라이언트 초기화 실패.');

    // 중복 확인 플래그 검사
    if (!isEmailChecked) {
        return alert('이메일 중복 확인을 먼저 완료해 주세요.');
    }

    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const phoneNumberEl = document.getElementById('phone_number');
    const companySelect = document.getElementById('company');
    const companyOtherInput = document.getElementById('companyOther');
    
    const email = emailEl.value.trim();
    const password = passwordEl.value;
    const phone_number = phoneNumberEl.value.trim();

    // 소속 회사 값 결정
    let company = companySelect.value;
    if (company === 'Other') {
        company = companyOtherInput.value.trim();
        if (!company) return alert('소속 회사명을 직접 입력해 주세요.');
    } else if (company === '') {
        company = '';
    }

    // 입력값 유효성 검사
    if (password.length < 6) return alert('비밀번호는 6자리 이상이어야 합니다.');
    if (!phone_number) return alert('휴대폰 번호는 필수 입력 항목입니다.');

    // Supabase 회원가입 실행
    const { error } = await client.auth.signUp({
        email: email,
        password: password,
        options: {
            data: {
                phone_number: phone_number,
                company: company
            }
        }
    });

    if(error) {
        console.error("회원가입 오류:", error);
        let userMessage = "회원가입 실패: " + error.message;
        if (error.message.includes('User already registered')) {
            userMessage = "이미 가입된 이메일 주소입니다. 로그인을 시도하거나 다른 이메일을 사용해 주세요.";
        }
        return alert(userMessage);
    }
    
    alert("회원가입 성공! 이메일 확인이 필요할 수 있습니다. 로그인 페이지로 이동합니다.");
    location.href="auth_login.html";
}
</script>
</body>
</html>
