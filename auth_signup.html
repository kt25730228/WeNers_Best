<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>회원가입 | WeNers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
/* 기본 폰트 설정 */
body { font-family: system-ui, -apple-system, sans-serif; }
/* 인풋 필드 기본 스타일 */
.input-style { @apply mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 }
</style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-2xl">
    <h2 class="text-3xl font-bold text-gray-800 text-center mb-8">회원가입</h2>

    <form id="signupForm" onsubmit="signup(event)" class="space-y-4">
        
        <div>
            <label for="email" class="block text-sm font-medium text-gray-700">이메일 주소 (아이디)</label>
            <div class="flex space-x-2">
                <input id="email" type="email" placeholder="사용할 이메일 입력" required
                       oninput="resetEmailStatus()"
                       class="flex-grow input-style"/>
                <button type="button" id="checkDuplicateBtn" onclick="checkEmailDuplication()"
                        class="px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out text-sm disabled:bg-gray-400">
                    중복 확인
                </button>
            </div>
            <p id="emailStatus" class="mt-1 text-sm text-red-500">중복 확인이 필요합니다.</p>
        </div>
        
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700">비밀번호</label>
            <input id="password" type="password" placeholder="특수문자, 영문, 숫자 포함 10자리 이상" required minlength="10"
                   class="input-style"/>
            <p id="passwordHint" class="mt-1 text-xs text-gray-500">영문, 숫자, 특수문자(!@#$%)를 포함하여 10자리 이상 입력하세요.</p>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">출생년월일</label>
            <div class="flex space-x-2 mt-1">
                <input id="birthYear" type="number" placeholder="YYYY" required maxlength="4" 
                       oninput="this.value=this.value.slice(0,this.maxLength)"
                       class="w-1/3 input-style text-center"/>
                <input id="birthMonth" type="number" placeholder="MM" required maxlength="2" 
                       oninput="this.value=this.value.slice(0,this.maxLength)"
                       class="w-1/3 input-style text-center"/>
                <input id="birthDay" type="number" placeholder="DD" required maxlength="2" 
                       oninput="this.value=this.value.slice(0,this.maxLength)"
                       class="w-1/3 input-style text-center"/>
            </div>
        </div>

        <div>
            <label for="phone_number" class="block text-sm font-medium text-gray-700">휴대폰 번호</label>
            <input id="phone_number" type="tel" placeholder="000-0000-0000 (11자리 숫자만 입력)" required maxlength="13" 
                   oninput="formatPhoneNumber(this)"
                   class="input-style"/>
        </div>

        <div>
            <label for="company" class="block text-sm font-medium text-gray-700">소속 회사</label>
            <select id="company" required
                    class="input-style bg-white">
                <option value="" disabled selected>-- 회사 선택 --</option>
                <option value="Webcash">웹케시</option>
                <option value="Coocon">쿠콘</option>
                <option value="Bizplay">비즈플레이</option>
                <option value="Biplepay">비플페이</option>
            </select>
        </div>

        <div>
            <label for="department" class="block text-sm font-medium text-gray-700">소속 부서</label>
            <input id="department" type="text" placeholder="예: 개발팀" required
                   class="input-style"/>
        </div>

        <button type="submit" id="signupBtn" 
                class="w-full p-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 ease-in-out">
            회원가입 완료
        </button>
    </form>
    
    <p class="text-center mt-6 text-sm">
        이미 계정이 있으신가요? 
        <a href="auth_login.html" class="text-blue-500 hover:text-blue-700 font-medium">로그인하기</a>
    </p>
</div>

<script>
let supabase = null; 
let isEmailChecked = false; // 이메일 중복 확인 플래그

// config.js의 전역 변수에서 Supabase 클라이언트 인스턴스를 가져오거나 생성합니다.
function getSupabaseClient() {
    if (window.supabase) return window.supabase;

    const url = window.SUPABASE_URL;
    const key = window.SUPABASE_ANON_KEY;
    
    if (url && key && window.supabase && typeof window.supabase.createClient === 'function') {
        window.supabase = window.supabase.createClient(url, key, { auth: { persistSession: false, autoRefreshToken: false } });
        return window.supabase;
    }
    return null;
}

document.addEventListener('DOMContentLoaded', () => {
    supabase = getSupabaseClient();
});

// --- 유틸리티 함수 ---

// 휴대폰 번호 하이픈 포맷팅
function formatPhoneNumber(input) {
    let num = input.value.replace(/[^0-9]/g, ''); // 숫자만 남김
    
    // 11자리 (00000000000) 일 때만 포맷 적용
    if (num.length === 11) {
        input.value = num.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    } else {
        // 11자리가 아닐 경우 하이픈 제거
        input.value = num;
    }
}

// 이메일 입력 시 중복 확인 상태 초기화
function resetEmailStatus() {
    isEmailChecked = false;
    document.getElementById('emailStatus').textContent = '중복 확인이 필요합니다.';
    document.getElementById('emailStatus').className = 'mt-1 text-sm text-red-500';
    document.getElementById('checkDuplicateBtn').disabled = false;
    document.getElementById('email').readOnly = false;
}

// 이메일 중복 확인 로직 (UI/UX 목적)
async function checkEmailDuplication() {
    const emailEl = document.getElementById('email');
    const email = emailEl.value.trim();
    const statusEl = document.getElementById('emailStatus');
    const checkBtn = document.getElementById('checkDuplicateBtn');

    if (!email || !email.includes('@')) {
        return alert('유효한 이메일 주소를 입력해 주세요.');
    }
    
    checkBtn.disabled = true;
    statusEl.textContent = '중복 확인 중...';
    statusEl.className = 'mt-1 text-sm text-blue-500';

    // 1.5초 딜레이 시뮬레이션
    await new Promise(resolve => setTimeout(resolve, 1500)); 

    // 데모: 항상 사용 가능하다고 가정하고 성공 상태로 변경
    isEmailChecked = true;
    statusEl.textContent = '사용 가능한 이메일 주소입니다.';
    statusEl.className = 'mt-1 text-sm text-green-600 font-bold';
    emailEl.readOnly = true; // 확인 완료 후 수정 불가
    checkBtn.disabled = true; 
}


// --- 메인 회원가입 로직 ---
async function signup(e){
    e.preventDefault();
    
    const client = getSupabaseClient();
    if(!client) return alert('Supabase 클라이언트 초기화 실패. config.js를 확인하세요.');

    // 1. 중복 확인 플래그 검사
    if (!isEmailChecked) {
        return alert('이메일 중복 확인을 먼저 완료해 주세요.');
    }

    // 2. 값 수집 및 유효성 검사
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const phone_number_formatted = document.getElementById('phone_number').value.trim();
    const company = document.getElementById('company').value;
    const department = document.getElementById('department').value.trim();
    
    const birthYear = document.getElementById('birthYear').value.trim();
    const birthMonth = document.getElementById('birthMonth').value.trim();
    const birthDay = document.getElementById('birthDay').value.trim();
    
    // 2.1. 비밀번호 복잡성 검사
    // 특수문자: [!@#$%] 중 하나, 영문: [a-zA-Z] 중 하나, 숫자: [0-9] 중 하나, 길이: {10,} 이상
    const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%])[A-Za-z\d!@#$%]{10,}$/;
    if (!passwordRegex.test(password)) {
        return alert('비밀번호는 영문, 숫자, 특수문자(!@#$%)를 포함하여 10자리 이상이어야 합니다.');
    }

    // 2.2. 휴대폰 번호 포맷 및 길이 검사 (하이픈 제거 후 11자리 확인)
    const phone_number = phone_number_formatted.replace(/-/g, '');
    if (phone_number.length !== 11) {
        return alert('휴대폰 번호 11자리를 정확히 입력해 주세요. (예: 01012345678)');
    }

    // 2.3. 출생년월일 검사 및 합산
    if (birthYear.length !== 4 || birthMonth.length !== 2 || birthDay.length !== 2) {
        return alert('출생년월일을 YYYY, MM, DD 형식(각각 4, 2, 2자리 숫자)으로 정확히 입력해 주세요.');
    }
    const birthday = `${birthYear}-${birthMonth}-${birthDay}`;
    if (new Date(birthday).toString() === 'Invalid Date') {
        return alert('유효하지 않은 날짜입니다. 월/일을 다시 확인해 주세요.');
    }

    // 2.4. 회사/부서 검사
    if (!company) {
        return alert('소속 회사를 선택해 주세요.');
    }
    if (!department) {
        return alert('소속 부서를 입력해 주세요.');
    }

    // 3. Supabase 회원가입 실행
    const { error } = await client.auth.signUp({
        email: email,
        password: password,
        options: {
            data: {
                phone_number: phone_number, // 하이픈 제거된 11자리 저장
                company: company,           // 선택된 회사명
                department: department,     // 입력된 부서명
                birthday: birthday          // YYYY-MM-DD 형식 저장
            }
        }
    });

    if(error) {
        console.error("회원가입 오류:", error);
        let userMessage = "회원가입 실패: " + error.message;
        if (error.message.includes('User already registered')) {
            userMessage = "이미 가입된 이메일 주소입니다. 로그인을 시도하거나 다른 이메일을 사용해 주세요.";
        }
        // 중복 확인은 통과했지만, 최종 DB 저장 시점에서 중복이 발견되면 UI 상태 재설정
        resetEmailStatus(); 
        document.getElementById('email').readOnly = false;
        
        return alert(userMessage);
    }
    
    alert("회원가입 성공! 이메일 확인이 필요할 수 있습니다. 로그인 페이지로 이동합니다.");
    location.href="auth_login.html";
}
</script>
</body>
</html>
