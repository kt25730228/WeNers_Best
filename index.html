<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeNers â€” ê²½ë§¤ í”Œë«í¼</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2/dist/tailwind.min.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
  "https://wfgqdswcdwdvfaqwejmd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmZ3Fkc3djZHdkdmZhcXdlam1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDc2NjcsImV4cCI6MjA4MDM4MzY2N30.Jb9nqalTEPp3Grwy3lnLczl6cE7gTSsK4Ol3hXGdl1Q"
);
</script>

<style>
html,body{margin:0;padding:0;font-family:Pretendard, sans-serif;}
.header-fixed{position:fixed;top:0;left:0;width:100%;background:white;z-index:50;box-shadow:0 2px 6px rgba(0,0,0,.06);}
.nav-wrap{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;}
.nav-left span{font-size:22px;font-weight:700;color:#2b8ded;}
.nav-right button{margin-left:10px;padding:6px 12px;border-radius:6px;border:1px solid #ddd;background:white;}
</style>
</head>

<body>

<!-- ğŸ”¥ Header â€” ë¡œê·¸ì¸ ìƒíƒœ(T1) / ë¯¸ë¡œê·¸ì¸ ìƒíƒœ ìë™ ì „í™˜ -->
<header class="header-fixed">
  <div class="nav-wrap">
    <div class="nav-left">
      <span>WeNers</span>
    </div>
    <div id="navAuth" class="nav-right">
      <!-- JSê°€ ì—¬ê¸°ë¥¼ ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ ì±„ìš´ë‹¤ -->
    </div>
  </div>
</header>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì„¸ì…˜ ê°ì§€ â†’ navAuth UI ë³€ê²½ (T1 ë°©ì‹ ì ìš©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderHeaderAuth(){
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user ?? null;
  const box = document.getElementById("navAuth");

  if(!user){
    box.innerHTML = `
      <button onclick="location.href='auth_login.html'">ë¡œê·¸ì¸</button>
      <button onclick="location.href='auth_signup.html'">íšŒì›ê°€ì…</button>
    `;
  } else {
    box.innerHTML = `
      <span style="font-weight:600;margin-right:8px;color:#2b8ded">${user.email}</span>
      <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    `;
  }
}
async function logout(){
  await supabase.auth.signOut();
  location.reload();
}
renderHeaderAuth();
</script>

<!-- â†“â†“â†“â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ì´ì–´ì„œ Part 2 ìš”ì²­í•˜ë©´ ë°”ë¡œ ì œê³µ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â†“â†“â†“ -->
  <!-- ================= Part 2/3 (Hero + ì¤‘ê°„ ì½˜í…ì¸ ) ================= -->
<!-- Hero / ìƒë‹¨ ë°°ë„ˆ -->
<main style="padding-top:88px;">
  <section id="hero" style="padding:60px 20px; background:linear-gradient(135deg,#06b6d4 0%,#60a5fa 100%); color:#fff;">
    <div style="max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:40px;">
      <div style="flex:1">
        <div style="background:rgba(255,255,255,0.12);display:inline-block;padding:6px 14px;border-radius:999px;font-weight:700;margin-bottom:12px">
          ğŸ”¥ ì˜¤ëŠ˜ ë“±ë¡ëœ ì‹ ê·œìƒí’ˆì´ <strong id="newCount">0</strong>ê°œ ìˆìŠµë‹ˆë‹¤.
        </div>
        <h1 style="font-size:44px;line-height:1.05;margin:12px 0 12px;font-weight:800">
          ì‘ì€ ê±°ë˜ë„ ì¦ê±°ìš´ ê²½í—˜ìœ¼ë¡œ<br/>
          ìœ„ë„ˆìŠ¤ì—ì„œ <strong style="color:#ffe600">íŒ”ë˜? ë§ë˜?</strong> ì‚´ë˜? ë§ë˜?
        </h1>
        <p style="opacity:.95;font-size:18px;margin-bottom:18px">íšŒì›ê°€ì…/ë¡œê·¸ì¸ í›„ ìƒí’ˆ ë“±ë¡ê³¼ ì‹¤ì‹œê°„ ì…ì°° ê¸°ëŠ¥ì„ ì²´í—˜í•´ë³´ì„¸ìš”.</p>
        <div>
          <a class="cta" href="weners_with_bids_realtime_auth.html" style="text-decoration:none;padding:12px 18px;border-radius:12px;background:#fff;color:#0ea5e9;font-weight:800">êµ¬ê²½í•˜ëŸ¬ ê°€ê¸°</a>
          <button onclick="location.href='create_with_image_upload_auth.html'" style="margin-left:12px;padding:12px 18px;border-radius:12px;border:none;background:rgba(255,255,255,0.12);color:#fff;font-weight:700">ìƒí’ˆ ë“±ë¡</button>
        </div>
      </div>
      <div style="width:360px;height:220px;border-radius:12px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center">
        <img src="https://placehold.co/140x140/fff/000?text=WeN" alt="visual" style="width:140px;height:140px;border-radius:10px">
      </div>
    </div>
  </section>

  <!-- ì‡¼íŠ¸ì»· / ì£¼ìš” ì„¹ì…˜ -->
  <section style="max-width:1100px;margin:30px auto;padding:0 20px;">
    <div style="display:flex;gap:20px;">
      <div style="flex:2;background:white;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.04)">
        <h3 style="margin:0 0 12px">ìµœê·¼ ìƒí’ˆ</h3>
        <div id="productList">
          <!-- JSë¡œ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
          <p style="color:#9ca3af">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      </div>

      <aside style="flex:1;">
        <div style="background:white;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.04);margin-bottom:16px">
          <h4 style="margin:0 0 8px">ë‚´ ê³„ì •</h4>
          <div id="miniAuth">
            <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì±„ì›€ -->
            <p style="color:#6b7280">ë¡œë”©ì¤‘...</p>
          </div>
        </div>

        <div style="background:white;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.04)">
          <h4 style="margin:0 0 8px">ê³µì§€</h4>
          <p style="color:#6b7280;margin:0">ìƒˆë¡œìš´ ê¸°ëŠ¥: ì´ë¯¸ì§€ ì—…ë¡œë“œ, ì‹¤ì‹œê°„ ì…ì°° í…ŒìŠ¤íŠ¸ ì¤‘</p>
        </div>
      </aside>
    </div>
  </section>
<!-- ================= Part 3/3 (Products, Scripts, Footer) ================= -->
  <footer style="max-width:1100px;margin:40px auto 80px;padding:0 20px;color:#64748b;font-size:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-top:1px solid #e6eefb">
      <div>Â© WeNers</div>
      <div>ë¬¸ì˜: support@example.com</div>
    </div>
  </footer>
</main>

<script>
// -----------------------------
// ì•ˆì „í•˜ê²Œ ìƒˆ supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ìë™ ì„¸ì…˜ ì €ì¥ X)
// -----------------------------
const SUPABASE_URL = "https://wfgqdswcdwdvfaqwejmd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmZ3Fkc3djZHdkdmZhcXdlam1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDc2NjcsImV4cCI6MjA4MDM4MzY2N30.Jb9nqalTEPp3Grwy3lnLczl6cE7gTSsK4Ol3hXGdl1Q";

// SB ë³€ìˆ˜ëŠ” ì´ íŒŒì¼ ë‚´ì—ì„œ ëª¨ë“  supabase ì‘ë™ì„ ë‹´ë‹¹
const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: false, autoRefreshToken: false }
});

// ì´ì œ SBë¥¼ í†µí•´ ì‚¬ìš©ì ìƒíƒœ/ë°ì´í„°ë¥¼ ê´€ë¦¬

// ìœ í‹¸: HTML ì´ìŠ¤ì¼€ì´í”„
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// -----------------------------
// í—¤ë”/ì‚¬ì´ë“œ/ë¯¸ë‹ˆ auth ì¬ë Œë”ë§ (SB ì‚¬ìš©)
// -----------------------------
async function refreshAllAuth(){
  const { data } = await SB.auth.getSession();
  const user = data?.session?.user ?? null;

  // header nav (override previous render if í•„ìš”)
  const box = document.getElementById("navAuth");
  if(box){
    if(!user){
      box.innerHTML = `<button onclick="location.href='auth_login.html'">ë¡œê·¸ì¸</button>
                       <button onclick="location.href='auth_signup.html'">íšŒì›ê°€ì…</button>`;
    } else {
      box.innerHTML = `<span style="font-weight:600;margin-right:8px;color:#2b8ded">${esc(user.email)}</span>
                       <button onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>`;
    }
  }

  // mini auth
  const mini = document.getElementById("miniAuth");
  if(mini){
    if(!user){
      mini.innerHTML = `<div><a href="auth_login.html">ë¡œê·¸ì¸</a> / <a href="auth_signup.html">íšŒì›ê°€ì…</a></div>`;
    } else {
      mini.innerHTML = `<div style="font-weight:600">${esc(user.email)}</div>
                        <div style="margin-top:8px"><button onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button></div>`;
    }
  }
}

// ì‹¤ì œ ë¡œê·¸ì•„ì›ƒ (ì„¸ì…˜ ì‚­ì œ + ìƒˆë¡œê³ ì¹¨)
async function doLogout(){
  try{
    await SB.auth.signOut();
  }catch(e){ console.warn('signOut err', e); }
  // í™•ì‹¤í•œ ì´ˆê¸°í™”: localStorage/sessionStorage clear (ì•ˆì „)
  try{ localStorage.clear(); sessionStorage.clear(); }catch(e){}
  location.reload();
}

// -----------------------------
// ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° & ì‹¤ì‹œê°„ êµ¬ë…
// -----------------------------
async function loadProducts(){
  const list = document.getElementById("productList");
  list.innerHTML = '<p style="color:#9ca3af">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
  try{
    const { data, error } = await SB.from('products').select('*').order('created_at',{ascending:false}).limit(20);
    if(error){
      console.error('products select err', error);
      list.innerHTML = `<p style="color:#ef4444">ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(error.message)}</p>`;
      return;
    }
    if(!data || data.length===0){
      list.innerHTML = '<p style="color:#6b7280">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      document.getElementById('newCount').textContent = 0;
      return;
    }

    document.getElementById('newCount').textContent = data.length;
    list.innerHTML = '';
    data.forEach(p=>{
      const html = `
        <div style="border-bottom:1px solid #eef2ff;padding:12px 0;display:flex;gap:12px;align-items:flex-start">
          <div style="width:140px;height:100px;background:#f8fafc;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center">
            ${p.images ? `<img src="${esc(p.images)}" style="width:100%;height:100%;object-fit:cover">` : `<div style="color:#9ca3af">ì´ë¯¸ì§€ ì—†ìŒ</div>`}
          </div>
          <div style="flex:1">
            <h4 style="margin:0 0 6px">${esc(p.title)}</h4>
            <div style="color:#6b7280;margin-bottom:8px">${esc(p.description||'')}</div>
            <div style="font-weight:700">ì‹œì‘ê°€: ${esc(p.price_start)}ì› ${p.price_end ? ` / ì¦‰ì‹œêµ¬ë§¤: ${esc(p.price_end)}ì›` : ''}</div>
            <div style="margin-top:10px">
              <input id="bid_${p.id}" type="number" placeholder="ì…ì°°ê°€" style="padding:8px;border:1px solid #e6eefb;border-radius:6px;width:140px">
              <button onclick="bidProduct(${p.id})" style="margin-left:8px;padding:8px 12px;border-radius:6px;background:#2b8ded;color:#fff;border:none">ì…ì°°</button>
            </div>
          </div>
        </div>`;
      list.insertAdjacentHTML('beforeend', html);
    });
  }catch(err){
    console.error('loadProducts unexpected', err);
    list.innerHTML = `<p style="color:#ef4444">ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
  }
}

// ì…ì°° í•¨ìˆ˜
async function bidProduct(pid){
  const el = document.getElementById(`bid_${pid}`);
  const price = Number(el.value);
  if(!price || price <= 0) return alert('ìœ íš¨í•œ ì…ì°°ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

  const { data: userData } = await SB.auth.getUser();
  const user = userData?.user;
  if(!user) return alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.');

  try{
    const { error } = await SB.from('bids').insert([{
      product_id: pid,
      price,
      bidder: user.email,
      created_at: new Date()
    }]);
    if(error){ console.error('bid insert err', error); return alert('ì…ì°° ì‹¤íŒ¨: '+error.message); }
    alert('ì…ì°° ì™„ë£Œ!');
  }catch(e){ console.error('bid unexpected', e); alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
}

// ì‹¤ì‹œê°„ êµ¬ë… (bids í…Œì´ë¸” INSERT ê°ì§€)
function subscribeRealtime(){
  try{
    SB.channel('public:realtime')
      .on('postgres_changes', { event: 'INSERT', schema:'public', table:'bids' }, (payload)=>{
        console.log('realtime bids:', payload);
        loadProducts(); // ê°„ë‹¨íˆ ìƒˆë¡œ ë¡œë“œ
      }).subscribe()
      .then(()=> console.log('subscribed to realtime bids'));
  }catch(e){ console.warn('subscribe err', e); }
}

// -----------------------------
// ì´ˆê¸°í™”: auth ë Œë” + ë°ì´í„° ë¡œë“œ + êµ¬ë…
// -----------------------------
(async function init(){
  await refreshAllAuth();
  await loadProducts();
  subscribeRealtime();
})();
</script>
</body>
</html>

