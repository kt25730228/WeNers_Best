<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ìœ„ë„ˆìŠ¤ ê²½ë§¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; }
  /* ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ (ì›ë³¸ ìœ ì§€) */
  @keyframes fadeA { 0%, 45% { opacity: 1; } 55%, 100% { opacity: 0.15; } }
  @keyframes fadeB { 0%, 45% { opacity: 0.15; } 55%, 100% { opacity: 1; } }
  .fade-a { animation: fadeA 3s infinite ease-in-out; }
  .fade-b { animation: fadeB 3s infinite ease-in-out; }
  @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
  .animate-float { animation: float 4s ease-in-out infinite; }
  .animate-float-delay { animation: float 4s ease-in-out infinite; animation-delay: 2s; }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <a href="index.html" class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-blue-600">WeNers</span>
                <span class="text-xs text-gray-500 hidden sm:inline">ê²½ë§¤ í”Œë«í¼</span>
            </a>

            <div class="flex items-center space-x-4">
                <span id="userBox" class="text-sm text-gray-700 font-medium hidden sm:block"></span>

                <a id="loginBtn" href="auth_login.html" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-700 transition duration-150 ease-in-out">
                    ë¡œê·¸ì¸
                </a>
                <a id="signupBtn" href="auth_signup.html" class="text-gray-600 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-100 transition duration-150 ease-in-out">
                    íšŒì›ê°€ì…
                </a>
                
                <button id="logoutBtn" onclick="logout()" style="display: none;" class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-red-600 transition duration-150 ease-in-out">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">ğŸ”¥ ì‹¤ì‹œê°„ ê²½ë§¤ ìƒí’ˆ</h1>
        <a id="createProductBtn" href="auth_login.html" class="flex items-center space-x-2 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-150 ease-in-out">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            <span>ìƒí’ˆ ë“±ë¡</span>
        </a>
    </div>

    <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        <p class="col-span-full text-center text-gray-500 py-10">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</main>

<footer class="mt-20 py-8 border-t bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
        &copy; 2025 WeNers Auction Platform. All rights reserved.
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script> 

<script>
// config.jsì—ì„œ ì „ì—­ìœ¼ë¡œ ì„¤ì •ëœ í‚¤/URLì„ 'const' ì—†ì´ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
const SUPABASE_URL_FROM_WINDOW = window.SUPABASE_URL;
const SUPABASE_ANON_KEY_FROM_WINDOW = window.SUPABASE_ANON_KEY;

let supabase = null;
let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´

if (SUPABASE_URL_FROM_WINDOW && SUPABASE_ANON_KEY_FROM_WINDOW) {
    supabase = supabase.createClient(SUPABASE_URL_FROM_WINDOW, SUPABASE_ANON_KEY_FROM_WINDOW, {
        auth: { persistSession: false }
    });
} else {
    console.error('Supabase ì„¤ì • (config.js)ì„ í™•ì¸í•˜ì„¸ìš”.');
}

// ----------------------------------------------------
// ğŸ”¥ 1. ê²½ë§¤ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
// ----------------------------------------------------

/** í˜„ì¬ ìƒí’ˆì˜ ìµœê³  ì…ì°°ê°€ë¥¼ DBì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤. */
async function getLatestBid(productId) {
    if (!supabase) return null;
    const { data: bids, error } = await supabase
        .from('bids')
        .select('price, bidder_id, created_at')
        .eq('product_id', productId)
        .order('price', { ascending: false })
        .limit(1);

    if (error) {
        console.error('ì…ì°°ê°€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        return null;
    }
    return bids[0] || null;
}

/** ìƒí’ˆ ëª©ë¡ ë° ìµœê³  ì…ì°°ê°€ë¥¼ ë¶ˆëŸ¬ì™€ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ */
async function loadProductsAndBids() {
    if (!supabase) return;
    const listEl = document.getElementById('product-list');
    if (!listEl) return;
    
    listEl.innerHTML = '<p class="text-center col-span-full py-10 text-gray-500">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    // 1. ìƒí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (íŒë§¤ë˜ì§€ ì•Šì€ ìƒí’ˆ & ë§ˆê° ì„ë°• ìˆœ)
    const { data: products, error: productError } = await supabase
        .from('products')
        .select('*')
        .eq('is_sold', false) 
        .order('end_date', { ascending: true }); 

    if (productError) {
        listEl.innerHTML = '<p class="text-center col-span-full py-10 text-red-500">ìƒí’ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + productError.message + '</p>';
        return;
    }
    
    if (!products || products.length === 0) {
        listEl.innerHTML = '<p class="text-center col-span-full py-10 text-gray-500">ë“±ë¡ëœ ê²½ë§¤ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆì„ ë“±ë¡í•´ ë³´ì„¸ìš”.</p>';
        return;
    }
    
    // 2. ê° ìƒí’ˆë³„ ìµœê³  ì…ì°°ê°€ ë¡œë“œ ë° ì¹´ë“œ ìƒì„±
    let html = '';
    for (const product of products) {
        const latestBid = await getLatestBid(product.id);
        html += renderProductCard(product, latestBid);
    }
    listEl.innerHTML = html;
}

/** Supabase ë°ì´í„°ë¥¼ ë°›ì•„ Tailwind ì¹´ë“œ HTMLì„ ìƒì„±í•©ë‹ˆë‹¤. */
function renderProductCard(product, latestBid) {
    const isEvent = product.type === 'event';
    const currentPrice = latestBid ? latestBid.price : product.price_start;
    const bidCount = latestBid ? 'ì…ì°° 1íšŒ ì´ìƒ' : 'ì²« ì…ì°°ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤';
    
    // ì´ë¯¸ì§€ ì²˜ë¦¬
    let imageUrl = '';
    if (product.images && product.images.length > 0) {
        imageUrl = Array.isArray(product.images) ? product.images[0] : product.images;
    }

    // ë§ˆê° ì‹œê°„ ê³„ì‚° ë° í¬ë§·
    const endDate = new Date(product.end_date);
    const timeRemainingSeconds = (endDate - new Date()) / 1000;
    const hoursRemaining = Math.floor(timeRemainingSeconds / 3600);
    const minutesRemaining = Math.floor((timeRemainingSeconds % 3600) / 60);

    const timerText = timeRemainingSeconds > 0 
        ? `${hoursRemaining}ì‹œê°„ ${minutesRemaining}ë¶„ ë‚¨ìŒ`
        : '<span class="text-red-500 font-bold">ê²½ë§¤ ë§ˆê°</span>';
    
    const isFinished = timeRemainingSeconds <= 0;

    return `
        <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 overflow-hidden ${isFinished ? 'opacity-70 grayscale' : ''}" data-product-id="${product.id}">
            ${imageUrl ? `<img class="w-full h-48 object-cover" src="${imageUrl}" alt="${product.title}">` : `<div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500">ì´ë¯¸ì§€ ì—†ìŒ</div>`}
            
            <div class="p-5">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${isEvent ? 'bg-yellow-100 text-yellow-700' : 'bg-indigo-100 text-indigo-700'}">${isEvent ? 'ì´ë²¤íŠ¸ ê²½ë§¤' : 'ì¼ë°˜ ê²½ë§¤'}</span>
                    <span class="text-xs text-gray-500">${timerText}</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 truncate">${product.title}</h3>
                <p class="text-sm text-gray-600 mb-4">${product.description || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                
                <div class="border-t border-b py-3 mb-4">
                    <p class="text-gray-500 text-sm">í˜„ì¬ê°€</p>
                    <p class="text-2xl font-extrabold text-blue-600">â‚© ${currentPrice.toLocaleString('ko-KR')}</p>
                    <p class="text-xs text-gray-400 mt-1">${bidCount}</p>
                </div>
                
                ${!isFinished ? `
                    <div class="flex items-center space-x-2 mb-4">
                        <input type="number" id="bid-input-${product.id}" placeholder="ì…ì°° ê¸ˆì•¡ (ìµœì†Œ ${currentPrice + 1}ì›)" 
                            min="${currentPrice + 1}" class="w-full border rounded-lg p-2 text-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    
                    <button onclick="placeBid(${product.id})" 
                            class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50">
                        ì¦‰ì‹œ ì…ì°°
                    </button>
                ` : `
                    <button disabled class="w-full bg-gray-400 text-white py-2 rounded-lg font-semibold">
                        ê²½ë§¤ ë§ˆê°
                    </button>
                `}
            </div>
        </div>
    `;
}

// ----------------------------------------------------
// ğŸ”¥ 2. ì…ì°° ë¡œì§ (Supabase DB ì €ì¥)
// ----------------------------------------------------
async function placeBid(productId) {
    // 1. ë¡œê·¸ì¸ í™•ì¸
    if (!currentUser) {
        alert('ë¡œê·¸ì¸ í›„ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        return window.location.href = 'auth_login.html';
    }

    const bidInput = document.getElementById(`bid-input-${productId}`);
    const bidAmount = Number(bidInput.value);

    // 2. ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
    if (isNaN(bidAmount) || bidAmount <= 0) {
        return alert('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    }

    // 3. í˜„ì¬ ìµœê³ ê°€ í™•ì¸ ë° ê²€ì¦
    const latestBid = await getLatestBid(productId);
    
    const productData = await supabase.from('products').select('price_start').eq('id', productId).single();
    const priceStart = productData.data?.price_start || 0;
    
    const currentPrice = latestBid ? latestBid.price : priceStart;
    
    if (bidAmount <= currentPrice) {
        return alert(`í˜„ì¬ ìµœê³ ê°€(${currentPrice.toLocaleString('ko-KR')}ì›)ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`);
    }

    // 4. Supabase 'bids' í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
    const { error } = await supabase
        .from('bids')
        .insert([{ 
            product_id: productId, 
            bidder_id: currentUser.id, 
            price: bidAmount 
        }]);

    if (error) {
        return alert('ì…ì°° ì‹¤íŒ¨: ' + error.message);
    }

    alert('ì…ì°° ì„±ê³µ! ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.');
    bidInput.value = ''; 
}


// ----------------------------------------------------
// ğŸ”¥ 3. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë° ì´ˆê¸°í™”
// ----------------------------------------------------

/** Supabase Realtime ì±„ë„ì„ êµ¬ë…í•˜ì—¬ ë°ì´í„° ë³€ê²½ ì‹œ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤. */
function subscribeToRealtime() {
    if (!supabase) return;

    // 'bids' í…Œì´ë¸” ë³€ê²½ ê°ì§€ (ìƒˆ ì…ì°° ë°œìƒ)
    supabase.channel('public:bids_changes')
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'bids' 
        }, payload => {
            console.log('ìƒˆë¡œìš´ ì…ì°° ê°ì§€:', payload);
            loadProductsAndBids(); // ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        })
        .subscribe();
    
    // 'products' í…Œì´ë¸” ë³€ê²½ ê°ì§€ (ìƒí’ˆ ë“±ë¡, ë§ˆê° ë“±)
    supabase.channel('public:products_changes')
        .on('postgres_changes', {
            event: '*', 
            schema: 'public', 
            table: 'products' 
        }, payload => {
            console.log('ìƒí’ˆ ë°ì´í„° ë³€ê²½ ê°ì§€:', payload);
            loadProductsAndBids(); // ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        })
        .subscribe();
}

// ----------------------------------------------------
// ğŸ”¥ 4. ì¸ì¦ ë° UI ê´€ë¦¬
// ----------------------------------------------------

/** ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë„¤ë¹„ê²Œì´ì…˜ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
async function checkAuthAndInit() {
    if (!supabase) return;
    
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session ? session.user : null;

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const signupBtn = document.getElementById('signupBtn');
    const userBox = document.getElementById('userBox');
    const createBtn = document.getElementById('createProductBtn');

    if (currentUser) {
        // ë¡œê·¸ì¸ ìƒíƒœ
        if (loginBtn) loginBtn.style.display = 'none';
        if (signupBtn) signupBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'inline-flex';
        if (userBox) userBox.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.email.split('@')[0]}ë‹˜!`;
        if (createBtn) createBtn.href = 'create_with_image_upload_auth.html'; 
    } else {
        // ë¹„ë¡œê·¸ì¸ ìƒíƒœ
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (signupBtn) signupBtn.style.display = 'inline-flex';
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (userBox) userBox.textContent = '';
        if (createBtn) createBtn.href = 'auth_login.html'; 
    }
    
    // ë°ì´í„° ë¡œë“œ ë° ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘
    loadProductsAndBids();
    subscribeToRealtime();
}

/** ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ */
async function logout() {
    if (!supabase) return;
    const { error } = await supabase.auth.signOut();
    if (error) {
        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message);
    } else {
        alert('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
        window.location.reload(); 
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
document.addEventListener('DOMContentLoaded', checkAuthAndInit);
</script>

</body>
</html>
