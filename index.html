<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ìœ„ë„ˆìŠ¤ ê²½ë§¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script> 

<style>
  body { font-family: system-ui, -apple-system, sans-serif; }
  /* ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ (ì›ë³¸ ìœ ì§€) */
  @keyframes fadeA { 0%, 45% { opacity: 1; } 55%, 100% { opacity: 0.15; } }
  @keyframes fadeB { 0%, 45% { opacity: 0.15; } 55%, 100% { opacity: 1; } }
  .fade-a { animation: fadeA 3s infinite ease-in-out; }
  .fade-b { animation: fadeB 3s infinite ease-in-out; }
  @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
  .animate-float { animation: float 4s ease-in-out infinite; }
  .animate-float-delay { animation: float 4s ease-in-out infinite; animation-delay: 2s; }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <a href="index.html" class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-blue-600">WeNers</span>
                <span class="text-xs text-gray-500 hidden sm:inline">ê²½ë§¤ í”Œë«í¼</span>
            </a>
            <div class="flex items-center space-x-4">
                <a href="create_with_image_upload_auth.html" id="createProductBtn" class="px-3 py-1 text-sm text-white bg-green-500 rounded-lg hover:bg-green-600 inline-flex items-center">
                    ìƒí’ˆ ë“±ë¡
                </a>
                <span id="userBox" class="text-sm text-gray-700 hidden sm:block"></span>
                <a href="auth_login.html" id="loginBtn" class="px-3 py-1 text-sm text-white bg-blue-600 rounded-lg hover:bg-blue-700 hidden sm:inline-flex items-center">ë¡œê·¸ì¸</a>
                <a href="auth_signup.html" id="signupBtn" class="px-3 py-1 text-sm text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 hidden sm:inline-flex items-center">íšŒì›ê°€ì…</a>
                <button onclick="logout()" id="logoutBtn" class="px-3 py-1 text-sm text-white bg-red-500 rounded-lg hover:bg-red-600 hidden items-center">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²½ë§¤</h2>
    
    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <p class="col-span-full text-center py-10 text-gray-500" id="loading-message">ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
</main>

<script>
const SUPABASE_URL = window.SUPABASE_URL;
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;

// â­ ìˆ˜ì •ë¨: supabase í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ì„ ì–¸í•©ë‹ˆë‹¤.
let supabase = null; 
let currentUser = null; 
let auctionEndDates = new Map();
let timerInterval = null;

// ğŸ”¥ 1. Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
function initializeSupabase() {
    if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase && typeof window.supabase.createClient === 'function') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: true, autoRefreshToken: true } 
        });
        window.supabase = supabase;
        return true;
    }
    console.error("Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: config.js ì„¤ì • ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
    return false;
}

// ğŸ”¥ 2. ì¸ì¦ ë° UI ê´€ë¦¬ (checkAuthAndInit í•¨ìˆ˜ ì¬êµ¬ì„±)
async function checkAuthAndInit() {
    // 1. í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹œë„
    if (!initializeSupabase()) {
        document.getElementById('product-list').innerHTML = '<p class="col-span-full text-center py-10 text-red-500">Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨. config.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>';
        return;
    }
    
    // 2. í˜„ì¬ ì„¸ì…˜ ì •ë³´ë¥¼ ê°€ì ¸ì™€ currentUserë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    const { data: { session } } = await supabase.auth.getSession(); 
    currentUser = session ? session.user : null;

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const signupBtn = document.getElementById('signupBtn');
    const userBox = document.getElementById('userBox');
    const createBtn = document.getElementById('createProductBtn');

    // 3. ì¸ì¦ ìƒíƒœì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
    if (currentUser) {
        if (loginBtn) loginBtn.style.display = 'none';
        if (signupBtn) signupBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'inline-flex';
        if (userBox) userBox.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.email.split('@')[0]}ë‹˜!`;
        // ë¡œê·¸ì¸ ì™„ë£Œ: ìƒí’ˆ ë“±ë¡ ë²„íŠ¼ì€ ë“±ë¡ í˜ì´ì§€ë¡œ
        if (createBtn) createBtn.href = 'create_with_image_upload_auth.html'; 
    } else {
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (signupBtn) signupBtn.style.display = 'inline-flex';
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (userBox) userBox.textContent = '';
        // ë¡œê·¸ì¸ì´ í•„ìš”: ìƒí’ˆ ë“±ë¡ ë²„íŠ¼ì€ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
        if (createBtn) createBtn.href = 'auth_login.html'; 
    }
    
    // 4. ìƒí’ˆ ë¡œë“œ ë° íƒ€ì´ë¨¸ ì‹œì‘
    loadProducts();
    // subscribeToRealtime(); // ì‹¤ì‹œê°„ êµ¬ë… ë¡œì§ì´ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
    
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimers, 1000);
}

// ğŸ”¥ 3. ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
async function logout() {
    if (!supabase) return;
    
    const { error } = await supabase.auth.signOut();
    if (error) {
        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message);
    } else {
        alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.reload(); 
    }
}

// ìƒí’ˆ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
async function loadProducts() {
    // ... (ìƒí’ˆ ë¡œë“œ ë¡œì§)
    const listEl = document.getElementById('product-list');
    const loadingEl = document.getElementById('loading-message');
    
    loadingEl.style.display = 'block';

    const { data, error } = await supabase
        .from('products')
        .select(`
            id, title, price_start, end_date, images
        `)
        .eq('is_sold', false) // íŒë§¤ë˜ì§€ ì•Šì€ ìƒí’ˆë§Œ
        .order('end_date', { ascending: true }); // ë§ˆê° ì„ë°•ìˆœ ì •ë ¬
        
    loadingEl.style.display = 'none';

    if (error) {
        listEl.innerHTML = '<p class="col-span-full text-center py-10 text-red-500">ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨</p>';
        console.error(error);
        return;
    }
    
    if (data.length === 0) {
        listEl.innerHTML = '<p class="col-span-full text-center py-10 text-gray-500">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    listEl.innerHTML = data.map(product => {
        const endTime = new Date(product.end_date);
        auctionEndDates.set(product.id, endTime);
        
        return `
            <a href="detail.html?id=${product.id}" class="block bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden">
                <div class="h-48 w-full bg-gray-200 flex items-center justify-center overflow-hidden">
                    <img src="${product.images[0] || 'placeholder.jpg'}" alt="${product.title}" class="object-cover w-full h-full">
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-bold text-gray-800 truncate">${product.title}</h3>
                    <p class="text-sm text-gray-600 mt-1">ì‹œì‘ê°€: â‚© ${product.price_start.toLocaleString('ko-KR')}</p>
                    <p id="timer-${product.id}" class="text-md font-extrabold mt-2 text-red-600">
                        </p>
                </div>
            </a>
        `;
    }).join('');
}

// íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
function updateTimers() {
    const now = new Date().getTime();
    auctionEndDates.forEach((endTime, id) => {
        const distance = endTime - now;
        const timerEl = document.getElementById(`timer-${id}`);

        if (distance < 0) {
            if (timerEl) timerEl.textContent = 'ê²½ë§¤ ì¢…ë£Œ';
        } else {
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            if (timerEl) timerEl.textContent = `${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ ë‚¨ìŒ`;
        }
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
document.addEventListener('DOMContentLoaded', checkAuthAndInit);
</script>
</body>
</html>
