<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>WeNers Auction Bids</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
/* 폰트 설정 */
body { font-family: system-ui, -apple-system, sans-serif; }
/* 버튼 hover 효과 유지 */
.button-primary:hover { @apply bg-blue-700; }
.button-secondary:hover { @apply bg-gray-500; }
</style>
</head>
<body class="bg-gray-100">

<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">WeNers 옥션</h1>
        <div class="space-x-4 flex items-center">
            <a href="create_with_image_upload_auth.html" id="createProductLink" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition duration-150 ease-in-out">
                상품 등록
            </a>
            <button id="authBtn" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition duration-150 ease-in-out">
                로그인
            </button>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">진행중인 경매</h2>
    
    <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div id="loading-message" class="col-span-full text-center text-lg text-gray-500 py-10">
            상품 정보를 불러오는 중...
        </div>
    </div>

    <div id="bid-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-20" onclick="closeBidModal(event)">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6" onclick="event.stopPropagation()">
            <h3 id="modal-product-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-current-bid" class="text-lg mb-4">현재 최고 입찰가: ₩0</p>
            
            <div class="space-y-4">
                <input type="number" id="bid-amount" placeholder="입찰 금액 입력 (최소 1,000원 단위)" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" min="1000" step="1000"/>
                
                <button onclick="submitBid()" 
                        class="w-full p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out">
                    입찰하기
                </button>
            </div>
            <button onclick="closeBidModal()" class="mt-4 text-sm text-gray-500 hover:text-gray-700">취소</button>
        </div>
    </div>
</main>

<script>
// Supabase 클라이언트 초기화는 config.js에서 처리하며, window.supabase 변수를 사용합니다.
let supabase = window.supabase;
let currentProducts = {}; // 상품 데이터를 저장할 객체
let modalProductId = null; // 현재 모달에서 처리 중인 상품 ID

document.addEventListener('DOMContentLoaded', () => {
    supabase = window.supabase; // config.js 로드 후 다시 할당
    if (!supabase) {
        document.getElementById('loading-message').textContent = 'Supabase 설정이 필요합니다. config.js를 확인하세요.';
        return;
    }
    
    checkAuth();
    fetchProductsAndBids();
    setupRealtime();
    setInterval(updateTimers, 1000); // 1초마다 남은 시간 업데이트
});

// --- 인증 및 UI 업데이트 함수 ---
async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser();
    const authBtn = document.getElementById('authBtn');
    
    if (user) {
        authBtn.textContent = '로그아웃';
        authBtn.onclick = logout;
    } else {
        authBtn.textContent = '로그인';
        authBtn.onclick = () => location.href = 'auth_login.html';
    }
}

async function logout() {
    const { error } = await supabase.auth.signOut();
    if (error) alert('로그아웃 실패: ' + error.message);
    else {
        alert('로그아웃되었습니다.');
        checkAuth(); // 버튼을 '로그인'으로 변경
        fetchProductsAndBids(); // 로그아웃 후 데이터 새로고침
    }
}

// --- 데이터 가져오기 및 렌더링 함수 ---

// 경매 상품과 최고 입찰가를 모두 가져오는 함수
async function fetchProductsAndBids() {
    document.getElementById('products-container').innerHTML = '<div id="loading-message" class="col-span-full text-center text-lg text-gray-500 py-10">상품 정보를 불러오는 중...</div>';
    
    const { data: products, error: productError } = await supabase
        .from('products')
        .select('*')
        .order('created_at', { ascending: false });

    if (productError) {
        console.error('상품 로드 오류:', productError);
        document.getElementById('loading-message').textContent = '상품 정보를 불러오는 데 실패했습니다.';
        return;
    }

    // 각 상품의 최고 입찰가를 병렬로 가져옴
    const bidPromises = products.map(product => 
        supabase
            .from('bids')
            .select('amount')
            .eq('product_id', product.id)
            .order('amount', { ascending: false })
            .limit(1)
            .maybeSingle()
            .then(({ data }) => ({
                ...product,
                current_bid: data ? data.amount : product.starting_price,
            }))
    );

    const productsWithBids = await Promise.all(bidPromises);
    
    currentProducts = productsWithBids.reduce((acc, p) => {
        acc[p.id] = p;
        return acc;
    }, {});
    
    renderProducts();
}

// 상품 카드를 HTML로 렌더링하는 함수
function renderProducts() {
    const container = document.getElementById('products-container');
    container.innerHTML = '';
    
    const productArray = Object.values(currentProducts);

    if (productArray.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-lg text-gray-500 py-10">등록된 경매 상품이 없습니다.</div>';
        return;
    }

    productArray.forEach(product => {
        const remainingTime = calculateRemainingTime(product.end_time);
        const isEnded = remainingTime.seconds <= 0;
        
        const cardHtml = `
            <div id="product-card-${product.id}" class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition duration-300 overflow-hidden flex flex-col">
                <a href="detail.html?id=${product.id}" class="block relative h-48 overflow-hidden">
                    <img src="${product.image_url || 'https://via.placeholder.com/600x400?text=No+Image'}" 
                         alt="${product.title}" class="w-full h-full object-cover transition duration-300 transform hover:scale-105">
                    ${isEnded ? '<div class="absolute inset-0 bg-red-600 bg-opacity-70 flex items-center justify-center"><span class="text-white text-2xl font-bold">경매 종료</span></div>' : ''}
                </a>
                <div class="p-5 flex-grow flex flex-col">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2 truncate">${product.title}</h3>
                    <p class="text-sm text-gray-500 mb-3">${product.description.substring(0, 50)}${product.description.length > 50 ? '...' : ''}</p>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-lg font-bold">
                            <span class="text-gray-900">현재가:</span>
                            <span id="bid-${product.id}" class="text-blue-600">${product.current_bid ? new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(product.current_bid) : '₩'+product.starting_price.toLocaleString('ko-KR')}</span>
                        </div>
                        <div id="timer-${product.id}" class="text-sm font-medium ${isEnded ? 'text-red-600' : 'text-green-600'}">
                            ${formatRemainingTime(remainingTime)}
                        </div>
                    </div>

                    <button ${isEnded ? 'disabled' : ''} 
                            onclick="openBidModal('${product.id}')" 
                            class="mt-auto w-full p-3 text-white rounded-lg font-semibold transition duration-150 ease-in-out ${isEnded ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}">
                        입찰하기
                    </button>
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;
    });
    // 타이머 즉시 업데이트 (초기 렌더링 시 시간 표시를 위해)
    updateTimers(); 
}

// --- 실시간 타이머 관련 함수 ---
function calculateRemainingTime(endTimeStr) {
    const endTime = new Date(endTimeStr).getTime();
    const now = new Date().getTime();
    const distance = endTime - now;
    
    if (distance <= 0) {
        return { days: 0, hours: 0, minutes: 0, seconds: 0 };
    }
    
    return {
        days: Math.floor(distance / (1000 * 60 * 60 * 24)),
        hours: Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
        minutes: Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)),
        seconds: Math.floor((distance % (1000 * 60)) / 1000),
    };
}

function formatRemainingTime(time) {
    if (time.days > 0) {
        return `${time.days}일 ${time.hours}시간 남음`;
    } else if (time.hours > 0) {
        return `${String(time.hours).padStart(2, '0')}:${String(time.minutes).padStart(2, '0')}:${String(time.seconds).padStart(2, '0')} 남음`;
    } else if (time.minutes > 0) {
        return `${String(time.minutes).padStart(2, '0')}:${String(time.seconds).padStart(2, '0')} 남음`;
    } else if (time.seconds > 0) {
        return `${time.seconds}초 남음`;
    } else {
        return '경매 종료';
    }
}

function updateTimers() {
    Object.values(currentProducts).forEach(product => {
        const timerEl = document.getElementById(`timer-${product.id}`);
        const bidBtn = document.querySelector(`#product-card-${product.id} button`);

        if (timerEl) {
            const time = calculateRemainingTime(product.end_time);
            const isEnded = time.seconds <= 0 && time.minutes <= 0 && time.hours <= 0 && time.days <= 0;

            timerEl.textContent = formatRemainingTime(time);

            if (isEnded) {
                // 경매 종료 상태 UI 업데이트
                if (!timerEl.classList.contains('text-red-600')) {
                    timerEl.classList.remove('text-green-600');
                    timerEl.classList.add('text-red-600');
                    if (bidBtn) {
                        bidBtn.disabled = true;
                        bidBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        bidBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        bidBtn.textContent = '경매 종료';
                    }
                    // 경매 종료 Overlay 추가 (렌더링 시 추가되도록 수정됨)
                    const card = document.getElementById(`product-card-${product.id}`);
                    if (card && !card.querySelector('.absolute.inset-0')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-red-600 bg-opacity-70 flex items-center justify-center';
                        overlay.innerHTML = '<span class="text-white text-2xl font-bold">경매 종료</span>';
                        card.querySelector('a').appendChild(overlay);
                    }
                }
            } else {
                 if (bidBtn) {
                    bidBtn.disabled = false;
                    bidBtn.textContent = '입찰하기';
                 }
            }
        }
    });
}

// --- 실시간 채널 설정 함수 ---
function setupRealtime() {
    supabase
        .channel('bids_realtime')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bids' }, (payload) => {
            const newBid = payload.new;
            console.log('New bid received:', newBid);
            updateProductBid(newBid.product_id, newBid.amount);
        })
        .subscribe();
}

// 실시간 입찰 업데이트 처리 함수
function updateProductBid(productId, newAmount) {
    if (currentProducts[productId]) {
        // 현재 최고 입찰가보다 높을 경우에만 업데이트
        if (newAmount > currentProducts[productId].current_bid) {
            currentProducts[productId].current_bid = newAmount;
            
            const bidEl = document.getElementById(`bid-${productId}`);
            if (bidEl) {
                bidEl.textContent = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(newAmount);
            }
            
            // 모달이 열려있다면 모달 내용도 업데이트
            if (modalProductId === productId) {
                document.getElementById('modal-current-bid').textContent = `현재 최고 입찰가: ${new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(newAmount)}`;
            }
        }
    }
}

// --- 입찰 모달 관련 함수 ---
function openBidModal(productId) {
    if (!supabase.auth.getUser()) {
        alert('로그인이 필요한 기능입니다.');
        location.href = 'auth_login.html';
        return;
    }
    
    modalProductId = productId;
    const product = currentProducts[productId];
    
    document.getElementById('modal-product-title').textContent = product.title;
    document.getElementById('modal-current-bid').textContent = `현재 최고 입찰가: ${new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(product.current_bid)}`;
    
    const bidAmountInput = document.getElementById('bid-amount');
    // 최소 입찰가 (현재가 + 1000)
    const minBidAmount = product.current_bid + 1000; 
    
    bidAmountInput.value = minBidAmount;
    bidAmountInput.min = minBidAmount; // HTML min 속성 설정
    
    document.getElementById('bid-modal').classList.remove('hidden');
    document.getElementById('bid-modal').classList.add('flex');
}

function closeBidModal() {
    document.getElementById('bid-modal').classList.remove('flex');
    document.getElementById('bid-modal').classList.add('hidden');
    modalProductId = null;
}

async function submitBid() {
    const bidAmount = parseInt(document.getElementById('bid-amount').value);
    
    if (!modalProductId) return;
    
    const product = currentProducts[modalProductId];
    const minAmount = product.current_bid + 1000;
    
    if (isNaN(bidAmount) || bidAmount < minAmount || bidAmount % 1000 !== 0) {
        return alert(`입찰 금액은 최소 ₩${minAmount.toLocaleString('ko-KR')} 이상이어야 하며, ₩1,000원 단위로 입력해야 합니다.`);
    }

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        alert('로그인이 필요합니다.');
        closeBidModal();
        location.href = 'auth_login.html';
        return;
    }
    
    // 입찰 데이터 삽입
    const { error } = await supabase
        .from('bids')
        .insert([
            {
                product_id: modalProductId,
                user_id: user.id,
                amount: bidAmount,
            },
        ]);

    if (error) {
        alert('입찰 실패: ' + error.message);
    } else {
        alert(`₩${bidAmount.toLocaleString('ko-KR')} 입찰 성공!`);
        closeBidModal();
        // 실시간 채널이 업데이트를 처리하므로, 별도로 fetchProductsAndBids를 호출하지 않습니다.
    }
}

// URL의 쿼리 파라미터를 파싱하는 함수 (detail.html로 이동 시 사용)
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};
</script>

</body>
</html>
