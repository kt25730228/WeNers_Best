<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ìƒí’ˆ ìƒì„¸ ì •ë³´ | WeNers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
Â  body { font-family: system-ui, -apple-system, sans-serif; }
Â  .active-thumb { border: 3px solid #3b82f6; } /* Tailwind blue-500 */
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-md sticky top-0 z-10">
Â  Â  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
Â  Â  Â  Â  <div class="flex justify-between items-center h-16">
Â  Â  Â  Â  Â  Â  <a href="index.html" class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-3xl font-extrabold text-blue-600">WeNers</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-gray-500 hidden sm:inline">ê²½ë§¤ í”Œë«í¼</span>
Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="userBox" class="text-sm text-gray-700 font-medium hidden sm:block"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <a id="loginBtn" href="auth_login.html" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">ë¡œê·¸ì¸</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a id="signupBtn" href="auth_signup.html" class="text-gray-600 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-100 transition">íšŒì›ê°€ì…</a>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="logoutBtn" onclick="logout()" style="display: none;" class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-red-600 transition">ë¡œê·¸ì•„ì›ƒ</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
Â  Â  <a href="index.html" class="text-blue-600 hover:text-blue-800 mb-4 inline-block text-sm">&larr; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
Â  Â Â 
Â  Â  <div id="loading" class="text-center py-20 text-xl font-medium text-gray-500">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
Â  Â Â 
Â  Â  <div id="productDetailContainer" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-10 bg-white p-8 rounded-xl shadow-lg">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="lg:col-span-2">
Â  Â  Â  Â  Â  Â  <h1 id="productTitle" class="text-3xl font-extrabold text-gray-800 mb-4"></h1>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="mainImageContainer" class="w-full h-96 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="mainImage" class="w-full h-full object-cover" src="" alt="ë©”ì¸ ìƒí’ˆ ì´ë¯¸ì§€">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="thumbnailContainer" class="flex space-x-2 overflow-x-auto p-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h3>
Â  Â  Â  Â  Â  Â  <p id="productDescription" class="text-gray-600 leading-relaxed whitespace-pre-wrap"></p>
Â  Â  Â  Â  Â  Â  <p id="sellerInfo" class="text-sm text-gray-400 mt-4">íŒë§¤ì: <span class="font-medium" id="sellerDisplay"></span></p>

Â  Â  Â  Â  Â  Â  <div class="mt-10">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">ì „ì²´ ì…ì°° ê¸°ë¡</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="bidHistoryList" class="max-h-96 overflow-y-auto space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-gray-500 py-4">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="lg:col-span-1 lg:sticky lg:top-20 h-fit bg-gray-50 p-6 rounded-lg border">
Â  Â  Â  Â  Â  Â  <div class="mb-6 pb-4 border-b">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="auctionStatus" class="inline-block text-sm font-semibold px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 mb-2"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="timerDisplay" class="text-2xl font-bold text-gray-700">ê²½ë§¤ ì¢…ë£Œê¹Œì§€: ê³„ì‚° ì¤‘...</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mt-1">ë§ˆê°ì¼ì‹œ: <span id="endDateDisplay"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="winningBidder" class="text-base font-semibold text-green-600 mt-3 hidden">ë‚™ì°°ì: <span id="winnerDisplay"></span></p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500">í˜„ì¬ ìµœê³ ê°€</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="currentPriceDisplay" class="text-4xl font-extrabold text-blue-600">â‚© 0</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="bidCountDisplay" class="text-sm text-gray-400 mt-1">ì´ ì…ì°° 0íšŒ</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="bidFormSection">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-2 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="bidInput" placeholder="ì…ì°° ê¸ˆì•¡"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  min="1" class="w-full border rounded-lg p-3 text-lg focus:border-blue-500 focus:ring-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button id="placeBidBtn" onclick="placeBid()"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ì¦‰ì‹œ ì…ì°°
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="auctionFinishedMessage" class="hidden w-full bg-gray-400 text-white py-3 rounded-lg font-semibold text-center">
Â  Â  Â  Â  Â  Â  Â  Â  ê²½ë§¤ ë§ˆê°
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <p id="bidMessage" class="text-xs text-center mt-3 text-red-500"></p>
Â  Â  Â  Â  </div>
Â  Â  </div>
</main>

<footer class="mt-20 py-8 border-t bg-white">
Â  Â  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
Â  Â  Â  Â  &copy; 2025 WeNers Auction Platform. All rights reserved.
Â  Â  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>Â 

<script>
// â­â­â­ 1. Supabase í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ë° ì¤‘ë³µ ì„ ì–¸ ë°©ì§€ â­â­â­
// config.jsì—ì„œ ì´ˆê¸°í™”ëœ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì™€ ì‚¬ìš©í•©ë‹ˆë‹¤.
const supabase = window.supabaseClient; 

let currentUser = null;Â 
let productId = null;Â  Â  Â  // í˜„ì¬ ìƒí’ˆ ID
let currentProduct = null; // í˜„ì¬ ìƒí’ˆ ë°ì´í„°
let timerInterval = null;Â  // íƒ€ì´ë¨¸ ì¸í„°ë²Œ ID

// âŒ ê¸°ì¡´ì˜ ë¶ˆí•„ìš”í•œ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ë¡œì§ ì œê±°:
// if (SUPABASE_URL_FROM_WINDOW && SUPABASE_ANON_KEY_FROM_WINDOW) { ... }

// ----------------------------------------------------
// ğŸ”¥ 1. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
// ----------------------------------------------------

function getProductIdFromUrl() {
Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  return parseInt(urlParams.get('id'));
}

/** ìƒí’ˆì˜ ìµœì‹  ì…ì°° ê¸°ë¡ê³¼ ëª¨ë“  ì…ì°° ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. */
async function getBidData(id) {
Â  Â  const { data: bids, error } = await supabase
Â  Â  Â  Â  .from('bids')
Â  Â  Â  Â  .select('price, bidder_id, created_at')
Â  Â  Â  Â  .eq('product_id', id)
Â  Â  Â  Â  .order('price', { ascending: false });

Â  Â  if (error) {
Â  Â  Â  Â  console.error('ì…ì°° ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
Â  Â  Â  Â  return { latestBid: null, allBids: [] };
Â  Â  }
Â  Â Â 
Â  Â  return {Â 
Â  Â  Â  Â  latestBid: bids.length > 0 ? bids[0] : null,Â 
Â  Â  Â  Â  allBids: bidsÂ 
Â  Â  };
}

/** ìƒí’ˆ ìƒì„¸ ì •ë³´ì™€ ì…ì°° ê¸°ë¡ì„ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤. */
async function loadProductDetail() {
Â  Â  document.getElementById('loading').style.display = 'block';
Â  Â  document.getElementById('productDetailContainer').style.display = 'none';

Â  Â  if (!supabase || !productId) {
Â  Â  Â  Â  document.getElementById('loading').textContent = 'ì˜ëª»ëœ ìƒí’ˆ ì •ë³´ì…ë‹ˆë‹¤.';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ìƒí’ˆ ë°ì´í„° ë¡œë“œ
Â  Â  const { data: product, error: productError } = await supabase
Â  Â  Â  Â  .from('products')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('id', productId)
Â  Â  Â  Â  .single();

Â  Â  if (productError || !product) {
Â  Â  Â  Â  document.getElementById('loading').textContent = 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
Â  Â  Â  Â  console.error(productError);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  currentProduct = product;

Â  Â  // ğŸ”¥ 1. ê²½ë§¤ ë§ˆê° ì²˜ë¦¬ (Cleanup Logic)
Â  Â  await handleAuctionEndCleanup(product);Â 

Â  Â  // ğŸ”¥ 2. ìƒì„¸ ì •ë³´ ë Œë”ë§
Â  Â  await renderProductDetails(currentProduct);
Â  Â Â 
Â  Â  // ğŸ”¥ 3. ì…ì°° ì •ë³´ ê°±ì‹ 
Â  Â  await updateBidInfo();

Â  Â  document.getElementById('loading').style.display = 'none';
Â  Â  document.getElementById('productDetailContainer').style.display = 'grid';

Â  Â  // ğŸ”¥ 4. íƒ€ì´ë¨¸ ì‹œì‘
Â  Â  if (timerInterval) clearInterval(timerInterval);
Â  Â  timerInterval = setInterval(updateTimerDisplay, 1000);
}

/** ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ HTML ìš”ì†Œì— ì±„ì›ë‹ˆë‹¤. */
async function renderProductDetails(product) {
Â  Â  document.getElementById('productTitle').textContent = product.title;
Â  Â  document.getElementById('productDescription').textContent = product.description || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
Â  Â  document.getElementById('endDateDisplay').textContent = new Date(product.end_date).toLocaleString('ko-KR');
Â  Â  document.getElementById('auctionStatus').textContent = product.type === 'event' ? 'ì´ë²¤íŠ¸ ê²½ë§¤' : 'ì¼ë°˜ ê²½ë§¤';
Â  Â Â 
Â  Â  // íŒë§¤ì ì •ë³´ í‘œì‹œ (ì²« 3ê¸€ì + ****)
Â  Â  const sellerDisplay = product.user_id ? product.user_id.substring(0, 3) + '****' : 'ì•Œ ìˆ˜ ì—†ìŒ';
Â  Â  document.getElementById('sellerDisplay').textContent = sellerDisplay;

Â  Â  // ğŸ”¥ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
Â  Â  renderImageGallery(product.images);
}

/** ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */
function renderImageGallery(images) {
Â  Â  const mainImageEl = document.getElementById('mainImage');
Â  Â  const thumbnailContainer = document.getElementById('thumbnailContainer');
Â  Â  thumbnailContainer.innerHTML = '';
Â  Â Â 
Â  Â  let imageUrls = [];
Â  Â  if (images && typeof images === 'string') {
Â  Â  Â  Â  imageUrls.push(images); // ë‹¨ì¼ ë¬¸ìì—´ì¸ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
Â  Â  } else if (Array.isArray(images)) {
Â  Â  Â  Â  imageUrls = images;
Â  Â  }
Â  Â Â 
Â  Â  if (imageUrls.length === 0) {
Â  Â  Â  Â  mainImageEl.src = '';
Â  Â  Â  Â  mainImageEl.alt = 'ì´ë¯¸ì§€ ì—†ìŒ';
Â  Â  Â  Â  mainImageEl.parentElement.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-500">ì´ë¯¸ì§€ ì—†ìŒ</div>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // ë©”ì¸ ì´ë¯¸ì§€ ì„¤ì •
Â  Â  mainImageEl.src = imageUrls[0];
Â  Â  mainImageEl.alt = currentProduct.title + ' ë©”ì¸ ì´ë¯¸ì§€';
Â  Â  mainImageEl.parentElement.innerHTML = ''; // í”Œë ˆì´ìŠ¤í™€ë” ì œê±°
Â  Â  mainImageEl.parentElement.appendChild(mainImageEl);

Â  Â  // ì¸ë„¤ì¼ ë Œë”ë§
Â  Â  imageUrls.forEach((url, index) => {
Â  Â  Â  Â  const thumb = document.createElement('img');
Â  Â  Â  Â  thumb.src = url;
Â  Â  Â  Â  thumb.className = `w-16 h-16 object-cover rounded-md cursor-pointer transition hover:opacity-80 ${index === 0 ? 'active-thumb' : 'border-2 border-transparent'}`;
Â  Â  Â  Â  thumb.dataset.index = index;
Â  Â  Â  Â  thumb.onclick = () => switchMainImage(index, imageUrls);
Â  Â  Â  Â  thumbnailContainer.appendChild(thumb);
Â  Â  });
}

/** ì¸ë„¤ì¼ì„ í´ë¦­í–ˆì„ ë•Œ ë©”ì¸ ì´ë¯¸ì§€ë¥¼ ì „í™˜í•©ë‹ˆë‹¤. */
function switchMainImage(index, imageUrls) {
Â  Â  const mainImageEl = document.getElementById('mainImage');
Â  Â  const thumbnails = document.getElementById('thumbnailContainer').children;
Â  Â Â 
Â  Â  // ë©”ì¸ ì´ë¯¸ì§€ ë³€ê²½
Â  Â  mainImageEl.src = imageUrls[index];
Â  Â Â 
Â  Â  // ì¸ë„¤ì¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
Â  Â  Array.from(thumbnails).forEach((thumb, i) => {
Â  Â  Â  Â  if (i === index) {
Â  Â  Â  Â  Â  Â  thumb.classList.add('active-thumb');
Â  Â  Â  Â  Â  Â  thumb.classList.remove('border-transparent');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  thumb.classList.remove('active-thumb');
Â  Â  Â  Â  Â  Â  thumb.classList.add('border-transparent');
Â  Â  Â  Â  }
Â  Â  });
}

/** ì…ì°° ì •ë³´ ë° ê¸°ë¡ì„ ê°±ì‹ í•˜ê³  í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
async function updateBidInfo() {
Â  Â  const { latestBid, allBids } = await getBidData(productId);
Â  Â  const priceStart = currentProduct.price_start || 0;
Â  Â  const currentPrice = latestBid ? latestBid.price : priceStart;

Â  Â  document.getElementById('currentPriceDisplay').textContent = `â‚© ${currentPrice.toLocaleString('ko-KR')}`;
Â  Â  document.getElementById('bidCountDisplay').textContent = `ì´ ì…ì°° ${allBids.length}íšŒ`;
Â  Â Â 
Â  Â  const bidInput = document.getElementById('bidInput');
Â  Â  if(bidInput) {
Â  Â  Â  Â  bidInput.placeholder = `ì…ì°° ê¸ˆì•¡ (ìµœì†Œ ${currentPrice + 1}ì›)`;
Â  Â  Â  Â  bidInput.min = currentPrice + 1;
Â  Â  }

Â  Â  // ë‚™ì°°ì ì •ë³´ í‘œì‹œ
Â  Â  const winnerDisplayEl = document.getElementById('winnerDisplay');
Â  Â  const winningBidderEl = document.getElementById('winningBidder');
Â  Â Â 
Â  Â  if (currentProduct.is_sold && (currentProduct.winning_bid_id || latestBid)) {
Â  Â  Â  Â  winningBidderEl.style.display = 'block';
Â  Â  Â  Â  const winnerId = currentProduct.winning_bid_id || (latestBid ? latestBid.bidder_id : 'ì•Œ ìˆ˜ ì—†ìŒ');
Â  Â  Â  Â  const winnerPrefix = winnerId.substring(0, 3);
Â  Â  Â  Â  winnerDisplayEl.textContent = winnerPrefix + '****';
Â  Â  } else {
Â  Â  Â  Â  winningBidderEl.style.display = 'none';
Â  Â  }

Â  Â  // ì…ì°° ê¸°ë¡ ë Œë”ë§
Â  Â  const listEl = document.getElementById('bidHistoryList');
Â  Â  if (!listEl) return;
Â  Â Â 
Â  Â  if (allBids.length === 0) {
Â  Â  Â  Â  listEl.innerHTML = '<p class="text-center text-gray-500 py-4">ì•„ì§ ì…ì°° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const maxPrice = allBids[0].price;

Â  Â  listEl.innerHTML = allBids.map(bid => {
Â  Â  Â  Â  const bidderPrefix = bid.bidder_id ? bid.bidder_id.substring(0, 3) : 'ìµëª…';
Â  Â  Â  Â  const maskedEmail = bidderPrefix + '****';Â 
Â  Â  Â  Â  const time = new Date(bid.created_at).toLocaleTimeString('ko-KR', {Â 
Â  Â  Â  Â  Â  Â  hour: '2-digit',Â 
Â  Â  Â  Â  Â  Â  minute: '2-digit',Â 
Â  Â  Â  Â  Â  Â  second: '2-digit'Â 
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center p-3 border rounded-md ${bid.price === maxPrice ? 'bg-yellow-50 border-yellow-300 font-bold' : 'bg-white'}">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-lg text-blue-600">â‚© ${bid.price.toLocaleString('ko-KR')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="block text-sm text-gray-700">${maskedEmail}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="block text-xs text-gray-500">${time}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  }).join('');

Â  Â  // ì…ì°° ê°€ëŠ¥/ë§ˆê° ìƒíƒœ ì—…ë°ì´íŠ¸ (íƒ€ì´ë¨¸ì™€ ì—°ë™)
Â  Â  updateTimerDisplay(true);
}

/** 1ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ ë¡œì§ */
function updateTimerDisplay(forceUpdate = false) {
Â  Â  if (!currentProduct) return;
Â  Â Â 
Â  Â  const endTime = new Date(currentProduct.end_date).getTime();
Â  Â  const now = new Date().getTime();
Â  Â  const remainingTime = endTime - now;
Â  Â Â 
Â  Â  const timerEl = document.getElementById('timerDisplay');
Â  Â  const formSection = document.getElementById('bidFormSection');
Â  Â  const finishedMsg = document.getElementById('auctionFinishedMessage');
Â  Â  const placeBidBtn = document.getElementById('placeBidBtn');
Â  Â Â 
Â  Â  if (remainingTime <= 0) {
Â  Â  Â  Â  // ê²½ë§¤ ë§ˆê° ì²˜ë¦¬ (UI)
Â  Â  Â  Â  timerEl.innerHTML = '<span class="text-red-600 font-bold">ê²½ë§¤ ì¢…ë£Œ: ë§ˆê°</span>';
Â  Â  Â  Â  timerEl.classList.remove('text-2xl', 'text-gray-700');
Â  Â  Â  Â  timerEl.classList.add('text-3xl');
Â  Â  Â  Â  formSection.style.display = 'none';
Â  Â  Â  Â  finishedMsg.style.display = 'block';

Â  Â  Â  Â  // ğŸ”¥ ë§ˆê° ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ë¡œì§ í˜¸ì¶œ
Â  Â  Â  Â  if (!currentProduct.is_sold) {
Â  Â  Â  Â  Â  Â  handleAuctionEndCleanup(currentProduct);
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ì‹œê°„ ê³„ì‚°
Â  Â  const days = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
Â  Â  const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
Â  Â  const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
Â  Â  const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

Â  Â  let timeString = '';
Â  Â  if (days > 0) {
Â  Â  Â  Â  timeString += `${days}ì¼ `;
Â  Â  }
Â  Â  timeString += `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
Â  Â Â 
Â  Â  timerEl.innerHTML = `ê²½ë§¤ ì¢…ë£Œê¹Œì§€: <span class="${remainingTime < 3600000 ? 'text-red-600' : 'text-blue-600'}">${timeString}</span>`;
Â  Â Â 
Â  Â  // ì…ì°° ë²„íŠ¼ í™œì„±í™”
Â  Â  formSection.style.display = 'block';
Â  Â  finishedMsg.style.display = 'none';
Â  Â  if(placeBidBtn) placeBidBtn.disabled = !currentUser;
Â  Â Â 
Â  Â  if (!currentUser) {
Â  Â  Â  Â  document.getElementById('bidMessage').textContent = 'ì…ì°°í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.';
Â  Â  } else {
Â  Â  Â  Â  document.getElementById('bidMessage').textContent = '';
Â  Â  }
}

// ----------------------------------------------------
// ğŸ”¥ 2. ê²½ë§¤ ë§ˆê° ì²˜ë¦¬ (í´ë¼ì´ì–¸íŠ¸ Cleanup)
// ----------------------------------------------------

/** * ê²½ë§¤ ë§ˆê° ì‹œê°„ì´ ì§€ë‚¬ëŠ”ë°ë„ DBì— is_soldê°€ falseì¼ ê²½ìš°Â 
Â * í•´ë‹¹ ìƒí’ˆì„ ë§ˆê° ì²˜ë¦¬í•˜ê³  ìµœê³  ì…ì°°ì ì •ë³´ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤. (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìˆ˜í–‰í•˜ëŠ” Cleanup ë¡œì§)
Â */
async function handleAuctionEndCleanup(product) {
Â  Â  const now = new Date().getTime();
Â  Â  const endTime = new Date(product.end_date).getTime();
Â  Â Â 
Â  Â  // ì´ë¯¸ is_soldê°€ trueì´ê±°ë‚˜ ì•„ì§ ë§ˆê° ì‹œê°„ì´ ì§€ë‚˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
Â  Â  if (product.is_sold === true || now < endTime) {
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  console.log(`ê²½ë§¤ ë§ˆê° ì •ë¦¬ ì‹œì‘: ìƒí’ˆ ID ${product.id}`);

Â  Â  // 1. ìµœê³  ì…ì°°ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
Â  Â  const { latestBid } = await getBidData(product.id);
Â  Â Â 
Â  Â  let updateData = {
Â  Â  Â  Â  is_sold: true,
Â  Â  };

Â  Â  if (latestBid) {
Â  Â  Â  Â  // ìµœê³  ì…ì°° ì •ë³´ê°€ ìˆì„ ê²½ìš°
Â  Â  Â  Â  updateData.price_end = latestBid.price;
Â  Â  Â  Â  updateData.winning_bid_id = latestBid.bidder_id;
Â  Â  Â  Â  console.log(`ë‚™ì°°ì: ${latestBid.bidder_id.substring(0, 5)}... , ë‚™ì°°ê°€: ${latestBid.price}`);
Â  Â  } else {
Â  Â  Â  Â  // ì…ì°°ì´ í•˜ë‚˜ë„ ì—†ì„ ê²½ìš° (ì‹œì‘ê°€ë¡œ ë§ˆê°)
Â  Â  Â  Â  updateData.price_end = product.price_start;
Â  Â  Â  Â  updateData.winning_bid_id = null;
Â  Â  Â  Â  console.log(`ì…ì°° ì—†ìŒ, ì‹œì‘ê°€ ${product.price_start}ì›ìœ¼ë¡œ ë§ˆê°`);
Â  Â  }

Â  Â  // 2. products í…Œì´ë¸” ì—…ë°ì´íŠ¸
Â  Â  const { data: updatedProduct, error: updateError } = await supabase
Â  Â  Â  Â  .from('products')
Â  Â  Â  Â  .update(updateData)
Â  Â  Â  Â  .eq('id', product.id)
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .single();
Â  Â Â 
Â  Â  if (updateError) {
Â  Â  Â  Â  console.error('ê²½ë§¤ ë§ˆê° ì •ë¦¬ ì‹¤íŒ¨:', updateError);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  console.log('ê²½ë§¤ ë§ˆê° ì •ë¦¬ ì™„ë£Œ. ìƒíƒœ ê°±ì‹ .');
Â  Â  // í˜„ì¬ ìƒí’ˆ ë°ì´í„° ê°±ì‹ 
Â  Â  currentProduct = updatedProduct;
Â  Â Â 
Â  Â  // ì…ì°° ì •ë³´ UI ê°•ì œ ê°±ì‹ 
Â  Â  updateBidInfo();Â 
}

// ----------------------------------------------------
// ğŸ”¥ 3. ì…ì°° ë¡œì§
// ----------------------------------------------------
async function placeBid() {
Â  Â  if (!currentUser) {
Â  Â  Â  Â  alert('ë¡œê·¸ì¸ í›„ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
Â  Â  Â  Â  return window.location.href = 'auth_login.html';
Â  Â  }
Â  Â Â 
Â  Â  if (new Date(currentProduct.end_date).getTime() <= new Date().getTime()) {
Â  Â  Â  Â  alert('ê²½ë§¤ê°€ ì´ë¯¸ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
Â  Â  Â  Â  // ë§ˆê° ì •ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
Â  Â  Â  Â  await handleAuctionEndCleanup(currentProduct);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const bidInput = document.getElementById('bidInput');
Â  Â  const bidAmount = Number(bidInput.value);

Â  Â  if (isNaN(bidAmount) || bidAmount <= 0) {
Â  Â  Â  Â  return alert('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
Â  Â  }

Â  Â  const { latestBid } = await getBidData(productId);
Â  Â  const priceStart = currentProduct.price_start || 0;
Â  Â  const currentPrice = latestBid ? latestBid.price : priceStart;
Â  Â Â 
Â  Â  if (bidAmount <= currentPrice) {
Â  Â  Â  Â  return alert(`í˜„ì¬ ìµœê³ ê°€(${currentPrice.toLocaleString('ko-KR')}ì›)ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`);
Â  Â  }

Â  Â  const { error } = await supabase
Â  Â  Â  Â  .from('bids')
Â  Â  Â  Â  .insert([{Â 
Â  Â  Â  Â  Â  Â  product_id: productId,Â 
Â  Â  Â  Â  Â  Â  bidder_id: currentUser.id,Â 
Â  Â  Â  Â  Â  Â  price: bidAmountÂ 
Â  Â  Â  Â  }]);

Â  Â  if (error) {
Â  Â  Â  Â  return alert('ì…ì°° ì‹¤íŒ¨: ' + error.message);
Â  Â  }

Â  Â  alert('ì…ì°° ì„±ê³µ! ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.');
Â  Â  bidInput.value = '';Â 
Â  Â  // ì„±ê³µ í›„ ìˆ˜ë™ìœ¼ë¡œ ì…ì°° ì •ë³´ë§Œ ê°±ì‹ 
Â  Â  updateBidInfo();
}

// ----------------------------------------------------
// ğŸ”¥ 4. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë° êµ¬ë…
// ----------------------------------------------------
function subscribeToRealtime() {
Â  Â  if (!supabase || !productId) return;

Â  Â  // 'bids' í…Œì´ë¸” ë³€ê²½ ê°ì§€ (ìƒˆ ì…ì°° ë°œìƒ)
Â  Â  supabase.channel(`product:${productId}_bids`)
Â  Â  Â  Â  .on('postgres_changes', {Â 
Â  Â  Â  Â  Â  Â  event: 'INSERT',Â 
Â  Â  Â  Â  Â  Â  schema: 'public',Â 
Â  Â  Â  Â  Â  Â  table: 'bids',
Â  Â  Â  Â  Â  Â  filter: `product_id=eq.${productId}`
Â  Â  Â  Â  }, payload => {
Â  Â  Â  Â  Â  Â  console.log('í•´ë‹¹ ìƒí’ˆì˜ ìƒˆë¡œìš´ ì…ì°° ê°ì§€:', payload);
Â  Â  Â  Â  Â  Â  updateBidInfo(); // í•´ë‹¹ ìƒí’ˆì˜ ì…ì°° ì •ë³´ë§Œ ìƒˆë¡œê³ ì¹¨
Â  Â  Â  Â  })
Â  Â  Â  Â  .subscribe();
}

// ----------------------------------------------------
// â­â­â­ 5. ì¸ì¦ ë° ì´ˆê¸°í™” (ìˆ˜ì •ëœ í•µì‹¬ ë¡œì§) â­â­â­
// ----------------------------------------------------
async function checkAuthAndInit() {
Â  Â  productId = getProductIdFromUrl();
Â  Â  if (!supabase) {
Â  Â  Â  Â  document.getElementById('loading').textContent = 'âš ï¸ Supabase ì´ˆê¸°í™” ì˜¤ë¥˜. config.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (!productId) {
Â  Â  Â  Â  document.getElementById('loading').textContent = 'ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ìƒí’ˆ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
Â  Â  Â  Â  return;
Â  Â  }

    // â­ ì„¸ì…˜ ì •ë³´ í™•ì¸: Local Storageì— ì €ì¥ëœ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ë³µì›í•©ë‹ˆë‹¤.
Â  Â  const { data: { session } } = await supabase.auth.getSession();
Â  Â  currentUser = session ? session.user : null;

Â  Â  // UI ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìƒíƒœ ë³€ê²½)
Â  Â  const loginBtn = document.getElementById('loginBtn');
Â  Â  const logoutBtn = document.getElementById('logoutBtn');
Â  Â  const signupBtn = document.getElementById('signupBtn');
Â  Â  const userBox = document.getElementById('userBox');

Â  Â  if (currentUser) {
Â  Â  Â  Â  if (loginBtn) loginBtn.style.display = 'none';
Â  Â  Â  Â  if (signupBtn) signupBtn.style.display = 'none';
Â  Â  Â  Â  if (logoutBtn) logoutBtn.style.display = 'inline-flex';
Â  Â  Â  Â  if (userBox) userBox.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.email.split('@')[0]}ë‹˜!`;
Â  Â  } else {
Â  Â  Â  Â  if (loginBtn) loginBtn.style.display = 'inline-flex';
Â  Â  Â  Â  if (signupBtn) signupBtn.style.display = 'inline-flex';
Â  Â  Â  Â  if (logoutBtn) logoutBtn.style.display = 'none';
Â  Â  Â  Â  if (userBox) userBox.textContent = '';
Â  Â  }
Â  Â Â 
    // ì¸ì¦ ìƒíƒœ í™•ì¸ í›„, ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ ë¡œë“œí•˜ê³  ì‹¤ì‹œê°„ êµ¬ë…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
Â  Â  loadProductDetail();
Â  Â  subscribeToRealtime();
}

async function logout() {
Â  Â  if (!supabase) return;
Â  Â  const { error } = await supabase.auth.signOut();
Â  Â  if (error) {
Â  Â  Â  Â  alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message);
Â  Â  } else {
Â  Â  Â  Â  alert('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
Â  Â  Â  Â  window.location.reload();Â 
Â  Â  }
}

document.addEventListener('DOMContentLoaded', checkAuthAndInit);
</script>
</body>
</html>
