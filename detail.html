<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ìƒí’ˆ ìƒì„¸ ì •ë³´ | WeNers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; }
  .active-thumb { border: 3px solid #3b82f6; } /* Tailwind blue-500 */
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <a href="index.html" class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-blue-600">WeNers</span>
                <span class="text-xs text-gray-500 hidden sm:inline">ê²½ë§¤ í”Œë«í¼</span>
            </a>
            <div class="flex items-center space-x-4">
                <span id="userBox" class="text-sm text-gray-700 font-medium hidden sm:block"></span>
                <a id="loginBtn" href="auth_login.html" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">ë¡œê·¸ì¸</a>
                <a id="signupBtn" href="auth_signup.html" class="text-gray-600 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-100 transition">íšŒì›ê°€ì…</a>
                <button id="logoutBtn" onclick="logout()" style="display: none;" class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-red-600 transition">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <a href="index.html" class="text-blue-600 hover:text-blue-800 mb-4 inline-block text-sm">&larr; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    
    <div id="loading" class="text-center py-20 text-xl font-medium text-gray-500">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div id="productDetailContainer" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-10 bg-white p-8 rounded-xl shadow-lg">
        
        <div class="lg:col-span-2">
            <h1 id="productTitle" class="text-3xl font-extrabold text-gray-800 mb-4"></h1>
            
            <div class="mb-6">
                <div id="mainImageContainer" class="w-full h-96 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center mb-4">
                    <img id="mainImage" class="w-full h-full object-cover" src="" alt="ë©”ì¸ ìƒí’ˆ ì´ë¯¸ì§€">
                </div>
                <div id="thumbnailContainer" class="flex space-x-2 overflow-x-auto p-1">
                    </div>
            </div>
            
            <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h3>
            <p id="productDescription" class="text-gray-600 leading-relaxed whitespace-pre-wrap"></p>
            <p id="sellerInfo" class="text-sm text-gray-400 mt-4">íŒë§¤ì: <span class="font-medium" id="sellerDisplay"></span></p>

            <div class="mt-10">
                <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">ì „ì²´ ì…ì°° ê¸°ë¡</h3>
                <div id="bidHistoryList" class="max-h-96 overflow-y-auto space-y-2">
                    <p class="text-center text-gray-500 py-4">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
        
        <div class="lg:col-span-1 lg:sticky lg:top-20 h-fit bg-gray-50 p-6 rounded-lg border">
            <div class="mb-6 pb-4 border-b">
                <span id="auctionStatus" class="inline-block text-sm font-semibold px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 mb-2"></span>
                <p id="timerDisplay" class="text-2xl font-bold text-gray-700">ê²½ë§¤ ì¢…ë£Œê¹Œì§€: ê³„ì‚° ì¤‘...</p>
                <p class="text-sm text-gray-500 mt-1">ë§ˆê°ì¼ì‹œ: <span id="endDateDisplay"></span></p>
                <p id="winningBidder" class="text-base font-semibold text-green-600 mt-3 hidden">ë‚™ì°°ì: <span id="winnerDisplay"></span></p>
            </div>

            <div class="mb-6">
                <p class="text-sm text-gray-500">í˜„ì¬ ìµœê³ ê°€</p>
                <p id="currentPriceDisplay" class="text-4xl font-extrabold text-blue-600">â‚© 0</p>
                <p id="bidCountDisplay" class="text-sm text-gray-400 mt-1">ì´ ì…ì°° 0íšŒ</p>
            </div>
            
            <div id="bidFormSection">
                <div class="flex items-center space-x-2 mb-4">
                    <input type="number" id="bidInput" placeholder="ì…ì°° ê¸ˆì•¡" 
                        min="1" class="w-full border rounded-lg p-3 text-lg focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <button id="placeBidBtn" onclick="placeBid()" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50">
                    ì¦‰ì‹œ ì…ì°°
                </button>
            </div>
            
            <div id="auctionFinishedMessage" class="hidden w-full bg-gray-400 text-white py-3 rounded-lg font-semibold text-center">
                ê²½ë§¤ ë§ˆê°
            </div>

            <p id="bidMessage" class="text-xs text-center mt-3 text-red-500"></p>
        </div>
    </div>
</main>

<footer class="mt-20 py-8 border-t bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
        &copy; 2025 WeNers Auction Platform. All rights reserved.
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script> 

<script>
// config.jsì—ì„œ ì „ì—­ìœ¼ë¡œ ì„¤ì •ëœ í‚¤/URLì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
const SUPABASE_URL_FROM_WINDOW = window.SUPABASE_URL;
const SUPABASE_ANON_KEY_FROM_WINDOW = window.SUPABASE_ANON_KEY;

let currentUser = null; 
let productId = null;      // í˜„ì¬ ìƒí’ˆ ID
let currentProduct = null; // í˜„ì¬ ìƒí’ˆ ë°ì´í„°
let timerInterval = null;  // íƒ€ì´ë¨¸ ì¸í„°ë²Œ ID

// Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
if (SUPABASE_URL_FROM_WINDOW && SUPABASE_ANON_KEY_FROM_WINDOW) {
    if (window.supabase && typeof window.supabase.createClient === 'function') {
        supabase = window.supabase.createClient(SUPABASE_URL_FROM_WINDOW, SUPABASE_ANON_KEY_FROM_WINDOW, {
            auth: { persistSession: false }
        });
    }
}

// ----------------------------------------------------
// ğŸ”¥ 1. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
// ----------------------------------------------------

function getProductIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return parseInt(urlParams.get('id'));
}

/** ìƒí’ˆì˜ ìµœì‹  ì…ì°° ê¸°ë¡ê³¼ ëª¨ë“  ì…ì°° ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. */
async function getBidData(id) {
    const { data: bids, error } = await supabase
        .from('bids')
        .select('price, bidder_id, created_at')
        .eq('product_id', id)
        .order('price', { ascending: false });

    if (error) {
        console.error('ì…ì°° ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        return { latestBid: null, allBids: [] };
    }
    
    return { 
        latestBid: bids.length > 0 ? bids[0] : null, 
        allBids: bids 
    };
}

/** ìƒí’ˆ ìƒì„¸ ì •ë³´ì™€ ì…ì°° ê¸°ë¡ì„ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤. */
async function loadProductDetail() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('productDetailContainer').style.display = 'none';

    if (!supabase || !productId) {
        document.getElementById('loading').textContent = 'ì˜ëª»ëœ ìƒí’ˆ ì •ë³´ì…ë‹ˆë‹¤.';
        return;
    }

    // ìƒí’ˆ ë°ì´í„° ë¡œë“œ
    const { data: product, error: productError } = await supabase
        .from('products')
        .select('*')
        .eq('id', productId)
        .single();

    if (productError || !product) {
        document.getElementById('loading').textContent = 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        console.error(productError);
        return;
    }
    currentProduct = product;

    // ğŸ”¥ 1. ê²½ë§¤ ë§ˆê° ì²˜ë¦¬ (Cleanup Logic)
    await handleAuctionEndCleanup(product); 

    // ğŸ”¥ 2. ìƒì„¸ ì •ë³´ ë Œë”ë§
    await renderProductDetails(currentProduct);
    
    // ğŸ”¥ 3. ì…ì°° ì •ë³´ ê°±ì‹ 
    await updateBidInfo();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('productDetailContainer').style.display = 'grid';

    // ğŸ”¥ 4. íƒ€ì´ë¨¸ ì‹œì‘
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimerDisplay, 1000);
}

/** ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ HTML ìš”ì†Œì— ì±„ì›ë‹ˆë‹¤. */
async function renderProductDetails(product) {
    document.getElementById('productTitle').textContent = product.title;
    document.getElementById('productDescription').textContent = product.description || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
    document.getElementById('endDateDisplay').textContent = new Date(product.end_date).toLocaleString('ko-KR');
    document.getElementById('auctionStatus').textContent = product.type === 'event' ? 'ì´ë²¤íŠ¸ ê²½ë§¤' : 'ì¼ë°˜ ê²½ë§¤';
    
    // íŒë§¤ì ì •ë³´ í‘œì‹œ (ì²« 3ê¸€ì + ****)
    const sellerDisplay = product.user_id ? product.user_id.substring(0, 3) + '****' : 'ì•Œ ìˆ˜ ì—†ìŒ';
    document.getElementById('sellerDisplay').textContent = sellerDisplay;

    // ğŸ”¥ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
    renderImageGallery(product.images);
}

/** ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */
function renderImageGallery(images) {
    const mainImageEl = document.getElementById('mainImage');
    const thumbnailContainer = document.getElementById('thumbnailContainer');
    thumbnailContainer.innerHTML = '';
    
    let imageUrls = [];
    if (images && typeof images === 'string') {
        imageUrls.push(images); // ë‹¨ì¼ ë¬¸ìì—´ì¸ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
    } else if (Array.isArray(images)) {
        imageUrls = images;
    }
    
    if (imageUrls.length === 0) {
        mainImageEl.src = '';
        mainImageEl.alt = 'ì´ë¯¸ì§€ ì—†ìŒ';
        mainImageEl.parentElement.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-500">ì´ë¯¸ì§€ ì—†ìŒ</div>';
        return;
    }
    
    // ë©”ì¸ ì´ë¯¸ì§€ ì„¤ì •
    mainImageEl.src = imageUrls[0];
    mainImageEl.alt = currentProduct.title + ' ë©”ì¸ ì´ë¯¸ì§€';
    mainImageEl.parentElement.innerHTML = ''; // í”Œë ˆì´ìŠ¤í™€ë” ì œê±°
    mainImageEl.parentElement.appendChild(mainImageEl);

    // ì¸ë„¤ì¼ ë Œë”ë§
    imageUrls.forEach((url, index) => {
        const thumb = document.createElement('img');
        thumb.src = url;
        thumb.className = `w-16 h-16 object-cover rounded-md cursor-pointer transition hover:opacity-80 ${index === 0 ? 'active-thumb' : 'border-2 border-transparent'}`;
        thumb.dataset.index = index;
        thumb.onclick = () => switchMainImage(index, imageUrls);
        thumbnailContainer.appendChild(thumb);
    });
}

/** ì¸ë„¤ì¼ì„ í´ë¦­í–ˆì„ ë•Œ ë©”ì¸ ì´ë¯¸ì§€ë¥¼ ì „í™˜í•©ë‹ˆë‹¤. */
function switchMainImage(index, imageUrls) {
    const mainImageEl = document.getElementById('mainImage');
    const thumbnails = document.getElementById('thumbnailContainer').children;
    
    // ë©”ì¸ ì´ë¯¸ì§€ ë³€ê²½
    mainImageEl.src = imageUrls[index];
    
    // ì¸ë„¤ì¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
    Array.from(thumbnails).forEach((thumb, i) => {
        if (i === index) {
            thumb.classList.add('active-thumb');
            thumb.classList.remove('border-transparent');
        } else {
            thumb.classList.remove('active-thumb');
            thumb.classList.add('border-transparent');
        }
    });
}

/** ì…ì°° ì •ë³´ ë° ê¸°ë¡ì„ ê°±ì‹ í•˜ê³  í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
async function updateBidInfo() {
    const { latestBid, allBids } = await getBidData(productId);
    const priceStart = currentProduct.price_start || 0;
    const currentPrice = latestBid ? latestBid.price : priceStart;

    document.getElementById('currentPriceDisplay').textContent = `â‚© ${currentPrice.toLocaleString('ko-KR')}`;
    document.getElementById('bidCountDisplay').textContent = `ì´ ì…ì°° ${allBids.length}íšŒ`;
    
    const bidInput = document.getElementById('bidInput');
    if(bidInput) {
        bidInput.placeholder = `ì…ì°° ê¸ˆì•¡ (ìµœì†Œ ${currentPrice + 1}ì›)`;
        bidInput.min = currentPrice + 1;
    }

    // ë‚™ì°°ì ì •ë³´ í‘œì‹œ
    const winnerDisplayEl = document.getElementById('winnerDisplay');
    const winningBidderEl = document.getElementById('winningBidder');
    
    if (currentProduct.is_sold && (currentProduct.winning_bid_id || latestBid)) {
        winningBidderEl.style.display = 'block';
        const winnerId = currentProduct.winning_bid_id || (latestBid ? latestBid.bidder_id : 'ì•Œ ìˆ˜ ì—†ìŒ');
        const winnerPrefix = winnerId.substring(0, 3);
        winnerDisplayEl.textContent = winnerPrefix + '****';
    } else {
        winningBidderEl.style.display = 'none';
    }

    // ì…ì°° ê¸°ë¡ ë Œë”ë§
    const listEl = document.getElementById('bidHistoryList');
    if (!listEl) return;
    
    if (allBids.length === 0) {
        listEl.innerHTML = '<p class="text-center text-gray-500 py-4">ì•„ì§ ì…ì°° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    const maxPrice = allBids[0].price;

    listEl.innerHTML = allBids.map(bid => {
        const bidderPrefix = bid.bidder_id ? bid.bidder_id.substring(0, 3) : 'ìµëª…';
        const maskedEmail = bidderPrefix + '****'; 
        const time = new Date(bid.created_at).toLocaleTimeString('ko-KR', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        
        return `
            <div class="flex justify-between items-center p-3 border rounded-md ${bid.price === maxPrice ? 'bg-yellow-50 border-yellow-300 font-bold' : 'bg-white'}">
                <span class="text-lg text-blue-600">â‚© ${bid.price.toLocaleString('ko-KR')}</span>
                <div class="text-right">
                    <span class="block text-sm text-gray-700">${maskedEmail}</span>
                    <span class="block text-xs text-gray-500">${time}</span>
                </div>
            </div>
        `;
    }).join('');

    // ì…ì°° ê°€ëŠ¥/ë§ˆê° ìƒíƒœ ì—…ë°ì´íŠ¸ (íƒ€ì´ë¨¸ì™€ ì—°ë™)
    updateTimerDisplay(true);
}

/** 1ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ ë¡œì§ */
function updateTimerDisplay(forceUpdate = false) {
    if (!currentProduct) return;
    
    const endTime = new Date(currentProduct.end_date).getTime();
    const now = new Date().getTime();
    const remainingTime = endTime - now;
    
    const timerEl = document.getElementById('timerDisplay');
    const formSection = document.getElementById('bidFormSection');
    const finishedMsg = document.getElementById('auctionFinishedMessage');
    const placeBidBtn = document.getElementById('placeBidBtn');
    
    if (remainingTime <= 0) {
        // ê²½ë§¤ ë§ˆê° ì²˜ë¦¬ (UI)
        timerEl.innerHTML = '<span class="text-red-600 font-bold">ê²½ë§¤ ì¢…ë£Œ: ë§ˆê°</span>';
        timerEl.classList.remove('text-2xl', 'text-gray-700');
        timerEl.classList.add('text-3xl');
        formSection.style.display = 'none';
        finishedMsg.style.display = 'block';

        // ğŸ”¥ ë§ˆê° ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ë¡œì§ í˜¸ì¶œ
        if (!currentProduct.is_sold) {
            handleAuctionEndCleanup(currentProduct);
        }
        return;
    }

    // ì‹œê°„ ê³„ì‚°
    const days = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
    const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

    let timeString = '';
    if (days > 0) {
        timeString += `${days}ì¼ `;
    }
    timeString += `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    timerEl.innerHTML = `ê²½ë§¤ ì¢…ë£Œê¹Œì§€: <span class="${remainingTime < 3600000 ? 'text-red-600' : 'text-blue-600'}">${timeString}</span>`;
    
    // ì…ì°° ë²„íŠ¼ í™œì„±í™”
    formSection.style.display = 'block';
    finishedMsg.style.display = 'none';
    if(placeBidBtn) placeBidBtn.disabled = !currentUser;
    
    if (!currentUser) {
        document.getElementById('bidMessage').textContent = 'ì…ì°°í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.';
    } else {
        document.getElementById('bidMessage').textContent = '';
    }
}

// ----------------------------------------------------
// ğŸ”¥ 2. ê²½ë§¤ ë§ˆê° ì²˜ë¦¬ (í´ë¼ì´ì–¸íŠ¸ Cleanup)
// ----------------------------------------------------

/** * ê²½ë§¤ ë§ˆê° ì‹œê°„ì´ ì§€ë‚¬ëŠ”ë°ë„ DBì— is_soldê°€ falseì¼ ê²½ìš° 
 * í•´ë‹¹ ìƒí’ˆì„ ë§ˆê° ì²˜ë¦¬í•˜ê³  ìµœê³  ì…ì°°ì ì •ë³´ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤. (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìˆ˜í–‰í•˜ëŠ” Cleanup ë¡œì§)
 */
async function handleAuctionEndCleanup(product) {
    const now = new Date().getTime();
    const endTime = new Date(product.end_date).getTime();
    
    // ì´ë¯¸ is_soldê°€ trueì´ê±°ë‚˜ ì•„ì§ ë§ˆê° ì‹œê°„ì´ ì§€ë‚˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    if (product.is_sold === true || now < endTime) {
        return;
    }

    console.log(`ê²½ë§¤ ë§ˆê° ì •ë¦¬ ì‹œì‘: ìƒí’ˆ ID ${product.id}`);

    // 1. ìµœê³  ì…ì°°ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const { latestBid } = await getBidData(product.id);
    
    let updateData = {
        is_sold: true,
    };

    if (latestBid) {
        // ìµœê³  ì…ì°° ì •ë³´ê°€ ìˆì„ ê²½ìš°
        updateData.price_end = latestBid.price;
        updateData.winning_bid_id = latestBid.bidder_id;
        console.log(`ë‚™ì°°ì: ${latestBid.bidder_id.substring(0, 5)}... , ë‚™ì°°ê°€: ${latestBid.price}`);
    } else {
        // ì…ì°°ì´ í•˜ë‚˜ë„ ì—†ì„ ê²½ìš° (ì‹œì‘ê°€ë¡œ ë§ˆê°)
        updateData.price_end = product.price_start;
        updateData.winning_bid_id = null;
        console.log(`ì…ì°° ì—†ìŒ, ì‹œì‘ê°€ ${product.price_start}ì›ìœ¼ë¡œ ë§ˆê°`);
    }

    // 2. products í…Œì´ë¸” ì—…ë°ì´íŠ¸
    const { data: updatedProduct, error: updateError } = await supabase
        .from('products')
        .update(updateData)
        .eq('id', product.id)
        .select('*')
        .single();
    
    if (updateError) {
        console.error('ê²½ë§¤ ë§ˆê° ì •ë¦¬ ì‹¤íŒ¨:', updateError);
        return;
    }
    
    console.log('ê²½ë§¤ ë§ˆê° ì •ë¦¬ ì™„ë£Œ. ìƒíƒœ ê°±ì‹ .');
    // í˜„ì¬ ìƒí’ˆ ë°ì´í„° ê°±ì‹ 
    currentProduct = updatedProduct;
    
    // ì…ì°° ì •ë³´ UI ê°•ì œ ê°±ì‹ 
    updateBidInfo(); 
}

// ----------------------------------------------------
// ğŸ”¥ 3. ì…ì°° ë¡œì§
// ----------------------------------------------------
async function placeBid() {
    if (!currentUser) {
        alert('ë¡œê·¸ì¸ í›„ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        return window.location.href = 'auth_login.html';
    }
    
    if (new Date(currentProduct.end_date).getTime() <= new Date().getTime()) {
        alert('ê²½ë§¤ê°€ ì´ë¯¸ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ë§ˆê° ì •ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
        await handleAuctionEndCleanup(currentProduct);
        return;
    }

    const bidInput = document.getElementById('bidInput');
    const bidAmount = Number(bidInput.value);

    if (isNaN(bidAmount) || bidAmount <= 0) {
        return alert('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    }

    const { latestBid } = await getBidData(productId);
    const priceStart = currentProduct.price_start || 0;
    const currentPrice = latestBid ? latestBid.price : priceStart;
    
    if (bidAmount <= currentPrice) {
        return alert(`í˜„ì¬ ìµœê³ ê°€(${currentPrice.toLocaleString('ko-KR')}ì›)ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`);
    }

    const { error } = await supabase
        .from('bids')
        .insert([{ 
            product_id: productId, 
            bidder_id: currentUser.id, 
            price: bidAmount 
        }]);

    if (error) {
        return alert('ì…ì°° ì‹¤íŒ¨: ' + error.message);
    }

    alert('ì…ì°° ì„±ê³µ! ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.');
    bidInput.value = ''; 
    // ì„±ê³µ í›„ ìˆ˜ë™ìœ¼ë¡œ ì…ì°° ì •ë³´ë§Œ ê°±ì‹ 
    updateBidInfo();
}

// ----------------------------------------------------
// ğŸ”¥ 4. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë° êµ¬ë…
// ----------------------------------------------------
function subscribeToRealtime() {
    if (!supabase || !productId) return;

    // 'bids' í…Œì´ë¸” ë³€ê²½ ê°ì§€ (ìƒˆ ì…ì°° ë°œìƒ)
    supabase.channel(`product:${productId}_bids`)
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'bids',
            filter: `product_id=eq.${productId}`
        }, payload => {
            console.log('í•´ë‹¹ ìƒí’ˆì˜ ìƒˆë¡œìš´ ì…ì°° ê°ì§€:', payload);
            updateBidInfo(); // í•´ë‹¹ ìƒí’ˆì˜ ì…ì°° ì •ë³´ë§Œ ìƒˆë¡œê³ ì¹¨
        })
        .subscribe();
}

// ----------------------------------------------------
// ğŸ”¥ 5. ì¸ì¦ ë° ì´ˆê¸°í™”
// ----------------------------------------------------
async function checkAuthAndInit() {
    productId = getProductIdFromUrl();
    if (!supabase || !productId) {
        document.getElementById('loading').textContent = 'ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ìƒí’ˆ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
        return;
    }

    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session ? session.user : null;

    // UI ì—…ë°ì´íŠ¸ (index.htmlê³¼ ë™ì¼í•œ ë¡œì§)
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const signupBtn = document.getElementById('signupBtn');
    const userBox = document.getElementById('userBox');

    if (currentUser) {
        if (loginBtn) loginBtn.style.display = 'none';
        if (signupBtn) signupBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'inline-flex';
        if (userBox) userBox.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.email.split('@')[0]}ë‹˜!`;
    } else {
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (signupBtn) signupBtn.style.display = 'inline-flex';
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (userBox) userBox.textContent = '';
    }
    
    loadProductDetail();
    subscribeToRealtime();
}

async function logout() {
    if (!supabase) return;
    const { error } = await supabase.auth.signOut();
    if (error) {
        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message);
    } else {
        alert('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
        window.location.reload(); 
    }
}

document.addEventListener('DOMContentLoaded', checkAuthAndInit);
</script>
</body>
</html>
