<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ìƒí’ˆ ìƒì„¸ ì •ë³´ | WeNers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script> 
<style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .active-thumb { border: 3px solid #3b82f6; } /* Tailwind blue-500 */
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <a href="index.html" class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-blue-600">WeNers</span>
                <span class="text-xs text-gray-500 hidden sm:inline">ê²½ë§¤ í”Œë«í¼</span>
            </a>
            <div class="flex items-center space-x-4">
                <span id="userBox" class="text-sm text-gray-700 hidden sm:block"></span>
                <a href="auth_login.html" id="loginBtn" class="px-3 py-1 text-sm text-white bg-blue-600 rounded-lg hover:bg-blue-700 hidden sm:inline-flex items-center">ë¡œê·¸ì¸</a>
                <a href="auth_signup.html" id="signupBtn" class="px-3 py-1 text-sm text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 hidden sm:inline-flex items-center">íšŒì›ê°€ì…</a>
                <button onclick="logout()" id="logoutBtn" class="px-3 py-1 text-sm text-white bg-red-500 rounded-lg hover:bg-red-600 hidden items-center">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div id="product-detail-container" class="bg-white shadow overflow-hidden sm:rounded-lg p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
        <p id="loadingContent" class="col-span-full text-center py-20 text-gray-500">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
</main>

<script>
// config.jsì—ì„œ ì „ì—­ìœ¼ë¡œ ì„¤ì •ëœ í‚¤/URLì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
const SUPABASE_URL = window.SUPABASE_URL;
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
let currentUser = null;
let supabase = null; // Supabase í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜

// ğŸ”¥ 1. Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜
function initializeSupabase() {
    if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase && typeof window.supabase.createClient === 'function') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            // â­ í•µì‹¬: ì„¸ì…˜ì„ ìœ ì§€í•˜ë„ë¡ ì„¤ì •
            auth: { persistSession: true, autoRefreshToken: true } 
        });
        window.supabase = supabase;
        return true;
    }
    console.error("Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: config.js ì„¤ì • ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
    return false;
}

// ğŸ”¥ 2. í˜ì´ì§€ ì´ˆê¸°í™” ë° ì„¸ì…˜ í™•ì¸
async function initializePage() {
    // 1. í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹œë„
    if (!initializeSupabase()) {
        document.getElementById('loadingContent').textContent = 'ì‹œìŠ¤í…œ ì˜¤ë¥˜: Supabase ì„¤ì • í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (!productId) {
        document.getElementById('loadingContent').textContent = 'ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ìƒí’ˆ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
        return;
    }

    // â­â­ ì„¸ì…˜ ì •ë³´ í™•ì¸ ë° ë³µì› â­â­
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session ? session.user : null;

    // UI ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìƒíƒœ ë³€ê²½)
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const signupBtn = document.getElementById('signupBtn');
    const userBox = document.getElementById('userBox');

    if (currentUser) {
        if (loginBtn) loginBtn.style.display = 'none';
        if (signupBtn) signupBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'inline-flex';
        if (userBox) userBox.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.email.split('@')[0]}ë‹˜!`;
    } else {
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (signupBtn) signupBtn.style.display = 'inline-flex';
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (userBox) userBox.textContent = '';
    }
    
    // ì´í›„ ìƒí’ˆ ë¡œë“œ ë¡œì§ í˜¸ì¶œ
    loadProductDetail(productId);
}

// ğŸ”¥ 3. ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
async function logout() {
    if (!supabase) return;
    
    const { error } = await supabase.auth.signOut();
    if (error) {
        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message);
    } else {
        alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    }
}

// --- (ë‚˜ë¨¸ì§€ ìƒí’ˆ ìƒì„¸/ì…ì°° ë¡œì§ì€ ìœ ì§€ë¨) ---

// ìƒí’ˆ ìƒì„¸ ì •ë³´ ë¡œë“œ
async function loadProductDetail(productId) {
    // ìƒí’ˆ ë¡œë“œ ë¡œì§
    const container = document.getElementById('product-detail-container');
    const loadingEl = document.getElementById('loadingContent');
    loadingEl.style.display = 'none';
    
    const { data: product, error } = await supabase
        .from('products')
        .select(`
            *,
            seller:seller_id (id, email, name)
        `)
        .eq('id', productId)
        .single();
        
    if (error) {
        container.innerHTML = `<p class="col-span-full text-center py-20 text-red-500">ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</p>`;
        console.error(error);
        return;
    }
    
    displayProduct(product);
}

function displayProduct(product) {
    // ìƒí’ˆ ì •ë³´ë¥¼ HTMLì— í‘œì‹œí•˜ëŠ” ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const container = document.getElementById('product-detail-container');
    // ... (ì‹¤ì œ ìƒí’ˆ ì •ë³´ í‘œì‹œ ë¡œì§)
    container.innerHTML = `
        <div class="col-span-1">
            <div id="main-image-display" class="w-full h-96 bg-gray-200 rounded-lg mb-4 flex items-center justify-center overflow-hidden">
                <img src="${product.images[0] || 'placeholder.jpg'}" alt="${product.title}" class="object-cover w-full h-full">
            </div>
            <div id="thumbnail-gallery" class="flex space-x-2">
                ${product.images.map((img, index) => `
                    <img src="${img}" alt="Thumbnail ${index + 1}" class="w-16 h-16 object-cover rounded-md cursor-pointer border hover:border-blue-500 ${index === 0 ? 'active-thumb' : ''}" onclick="changeMainImage('${img}', this)">
                `).join('')}
            </div>
        </div>
        
        <div class="col-span-1 space-y-4">
            <h1 class="text-4xl font-extrabold text-gray-900">${product.title}</h1>
            <p class="text-gray-600 text-lg">${product.description}</p>
            
            <div class="border-t pt-4 space-y-2">
                <p class="text-xl font-medium text-gray-700">ì‹œì‘ê°€: <span class="text-gray-900 font-bold">â‚© ${product.price_start.toLocaleString('ko-KR')}</span></p>
                <p class="text-xl font-medium text-gray-700">ë§ˆê° ì¼ì‹œ: <span class="text-red-500 font-bold">${new Date(product.end_date).toLocaleString('ko-KR')}</span></p>
            </div>
            
            <div class="pt-4 space-y-4">
                <button onclick="placeBidModal()" class="w-full p-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition">
                    ì…ì°°í•˜ê¸°
                </button>
            </div>
            
            <p class="text-sm text-gray-500 pt-2">íŒë§¤ì: ${product.seller ? product.seller.email : 'ì •ë³´ ì—†ìŒ'}</p>
        </div>
    `;
    
}

// ì´ë¯¸ì§€ ë³€ê²½ í•¨ìˆ˜ (ì„ì‹œ ë¡œì§)
function changeMainImage(src, element) {
    document.getElementById('main-image-display').querySelector('img').src = src;
    document.querySelectorAll('#thumbnail-gallery img').forEach(img => img.classList.remove('active-thumb'));
    element.classList.add('active-thumb');
}

// ì…ì°° ëª¨ë‹¬ ë„ìš°ê¸° (ì‹¤ì œ ë¡œì§ì€ ìƒëµë¨)
function placeBidModal() {
    if (!currentUser) {
        alert('ì…ì°°ì„ ìœ„í•´ì„œëŠ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'auth_login.html';
        return;
    }
    alert(`ì…ì°° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì: ${currentUser.email}`);
}


document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
