<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ìƒí’ˆ ìƒì„¸ ì •ë³´ | WeNers</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <a href="index.html" class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-blue-600">WeNers</span>
                <span class="text-xs text-gray-500 hidden sm:inline">ê²½ë§¤ í”Œë«í¼</span>
            </a>
            <div class="flex items-center space-x-4">
                <span id="userBox" class="text-sm text-gray-700 font-medium hidden sm:block"></span>
                <a id="loginBtn" href="auth_login.html" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">ë¡œê·¸ì¸</a>
                <a id="signupBtn" href="auth_signup.html" class="text-gray-600 px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-gray-100 transition">íšŒì›ê°€ì…</a>
                <button id="logoutBtn" onclick="logout()" style="display: none;" class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-red-600 transition">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <a href="index.html" class="text-blue-600 hover:text-blue-800 mb-4 inline-block">&larr; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    
    <div id="loading" class="text-center py-20 text-xl font-medium text-gray-500">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div id="productDetailContainer" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-10 bg-white p-8 rounded-xl shadow-lg">
        
        <div class="lg:col-span-2">
            <h1 id="productTitle" class="text-3xl font-extrabold text-gray-800 mb-4"></h1>
            <div id="productImage" class="w-full h-96 bg-gray-200 rounded-lg overflow-hidden mb-6">
                </div>
            
            <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">ìƒí’ˆ ìƒì„¸ ì„¤ëª…</h3>
            <p id="productDescription" class="text-gray-600 leading-relaxed"></p>

            <div class="mt-10">
                <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">ì „ì²´ ì…ì°° ê¸°ë¡</h3>
                <div id="bidHistoryList" class="max-h-96 overflow-y-auto space-y-2">
                    <p class="text-center text-gray-500 py-4">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
        
        <div class="lg:col-span-1 lg:sticky lg:top-20 h-fit bg-gray-50 p-6 rounded-lg border">
            <div class="mb-6 pb-4 border-b">
                <span id="auctionStatus" class="inline-block text-sm font-semibold px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 mb-2"></span>
                <p id="timerDisplay" class="text-2xl font-bold text-gray-700">ê²½ë§¤ ì¢…ë£Œê¹Œì§€: ê³„ì‚° ì¤‘...</p>
                <p class="text-sm text-gray-500 mt-1">ë§ˆê°ì¼ì‹œ: <span id="endDateDisplay"></span></p>
            </div>

            <div class="mb-6">
                <p class="text-sm text-gray-500">í˜„ì¬ ìµœê³ ê°€</p>
                <p id="currentPriceDisplay" class="text-4xl font-extrabold text-blue-600">â‚© 0</p>
                <p id="bidCountDisplay" class="text-sm text-gray-400 mt-1">ì´ ì…ì°° 0íšŒ</p>
            </div>
            
            <div id="bidFormSection">
                <div class="flex items-center space-x-2 mb-4">
                    <input type="number" id="bidInput" placeholder="ì…ì°° ê¸ˆì•¡" 
                        min="1" class="w-full border rounded-lg p-3 text-lg focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <button id="placeBidBtn" onclick="placeBid()" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50">
                    ì¦‰ì‹œ ì…ì°°
                </button>
            </div>
            
            <div id="auctionFinishedMessage" class="hidden w-full bg-gray-400 text-white py-3 rounded-lg font-semibold text-center">
                ê²½ë§¤ ë§ˆê°
            </div>

            <p id="bidMessage" class="text-xs text-center mt-3 text-red-500"></p>
        </div>
    </div>
</main>

<footer class="mt-20 py-8 border-t bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
        &copy; 2025 WeNers Auction Platform. All rights reserved.
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script> 

<script>
// config.jsì—ì„œ ì „ì—­ìœ¼ë¡œ ì„¤ì •ëœ í‚¤/URLì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
const SUPABASE_URL_FROM_WINDOW = window.SUPABASE_URL;
const SUPABASE_ANON_KEY_FROM_WINDOW = window.SUPABASE_ANON_KEY;

let supabase = null; 
let currentUser = null; 
let productId = null;      // í˜„ì¬ ìƒí’ˆ ID
let currentProduct = null; // í˜„ì¬ ìƒí’ˆ ë°ì´í„°
let timerInterval = null;  // íƒ€ì´ë¨¸ ì¸í„°ë²Œ ID

// Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
if (SUPABASE_URL_FROM_WINDOW && SUPABASE_ANON_KEY_FROM_WINDOW) {
    if (window.supabase && typeof window.supabase.createClient === 'function') {
        supabase = window.supabase.createClient(SUPABASE_URL_FROM_WINDOW, SUPABASE_ANON_KEY_FROM_WINDOW, {
            auth: { persistSession: false }
        });
    }
}

// ----------------------------------------------------
// ğŸ”¥ 1. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
// ----------------------------------------------------

// í˜„ì¬ URLì—ì„œ product_idë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
function getProductIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return parseInt(urlParams.get('id'));
}

/** ìƒí’ˆì˜ ìµœì‹  ì…ì°° ê¸°ë¡ê³¼ ëª¨ë“  ì…ì°° ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. */
async function getBidData(id) {
    const { data: bids, error } = await supabase
        .from('bids')
        .select('price, bidder_id, created_at')
        .eq('product_id', id)
        .order('price', { ascending: false });

    if (error) {
        console.error('ì…ì°° ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        return { latestBid: null, allBids: [] };
    }
    
    return { 
        latestBid: bids.length > 0 ? bids[0] : null, 
        allBids: bids 
    };
}

/** ìƒí’ˆ ìƒì„¸ ì •ë³´ì™€ ì…ì°° ê¸°ë¡ì„ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤. */
async function loadProductDetail() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('productDetailContainer').style.display = 'none';

    if (!supabase || !productId) {
        document.getElementById('loading').textContent = 'ì˜ëª»ëœ ìƒí’ˆ ì •ë³´ì…ë‹ˆë‹¤.';
        return;
    }

    // ìƒí’ˆ ë°ì´í„° ë¡œë“œ
    const { data: product, error: productError } = await supabase
        .from('products')
        .select('*')
        .eq('id', productId)
        .single();

    if (productError || !product) {
        document.getElementById('loading').textContent = 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        console.error(productError);
        return;
    }
    currentProduct = product;

    // ì…ì°° ë°ì´í„° ë¡œë“œ
    await renderProductDetails(product);
    await updateBidInfo();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('productDetailContainer').style.display = 'grid';

    // ğŸ”¥ íƒ€ì´ë¨¸ ì‹œì‘
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimerDisplay, 1000);
}

/** ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ HTML ìš”ì†Œì— ì±„ì›ë‹ˆë‹¤. */
async function renderProductDetails(product) {
    document.getElementById('productTitle').textContent = product.title;
    document.getElementById('productDescription').textContent = product.description || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
    document.getElementById('endDateDisplay').textContent = new Date(product.end_date).toLocaleString('ko-KR');
    document.getElementById('auctionStatus').textContent = product.type === 'event' ? 'ì´ë²¤íŠ¸ ê²½ë§¤' : 'ì¼ë°˜ ê²½ë§¤';
    
    // ì´ë¯¸ì§€ ì²˜ë¦¬
    const imageContainer = document.getElementById('productImage');
    imageContainer.innerHTML = '';
    let imageUrl = (product.images && product.images.length > 0) 
        ? (Array.isArray(product.images) ? product.images[0] : product.images) 
        : null;

    if (imageUrl) {
        imageContainer.innerHTML = `<img src="${imageUrl}" alt="${product.title}" class="w-full h-full object-cover">`;
    } else {
        imageContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-500">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
    }
}

/** ì…ì°° ì •ë³´ ë° ê¸°ë¡ì„ ê°±ì‹ í•˜ê³  í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
async function updateBidInfo() {
    const { latestBid, allBids } = await getBidData(productId);
    const priceStart = currentProduct.price_start || 0;
    const currentPrice = latestBid ? latestBid.price : priceStart;

    document.getElementById('currentPriceDisplay').textContent = `â‚© ${currentPrice.toLocaleString('ko-KR')}`;
    document.getElementById('bidCountDisplay').textContent = `ì´ ì…ì°° ${allBids.length}íšŒ`;
    
    const bidInput = document.getElementById('bidInput');
    if(bidInput) {
        bidInput.placeholder = `ì…ì°° ê¸ˆì•¡ (ìµœì†Œ ${currentPrice + 1}ì›)`;
        bidInput.min = currentPrice + 1;
    }

    // ì…ì°° ê¸°ë¡ ë Œë”ë§
    const listEl = document.getElementById('bidHistoryList');
    if (!listEl) return;
    
    if (allBids.length === 0) {
        listEl.innerHTML = '<p class="text-center text-gray-500 py-4">ì•„ì§ ì…ì°° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    const maxPrice = allBids[0].price;

    listEl.innerHTML = allBids.map(bid => {
        // ì´ë©”ì¼ ID ì• 3ê¸€ì ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ (index.htmlê³¼ ë™ì¼)
        const bidderPrefix = bid.bidder_id ? bid.bidder_id.substring(0, 3) : 'ìµëª…';
        const maskedEmail = bidderPrefix + '****'; 
        const time = new Date(bid.created_at).toLocaleTimeString('ko-KR', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        
        return `
            <div class="flex justify-between items-center p-3 border rounded-md ${bid.price === maxPrice ? 'bg-yellow-50 border-yellow-300 font-bold' : 'bg-white'}">
                <span class="text-lg text-blue-600">â‚© ${bid.price.toLocaleString('ko-KR')}</span>
                <div class="text-right">
                    <span class="block text-sm text-gray-700">${maskedEmail}</span>
                    <span class="block text-xs text-gray-500">${time}</span>
                </div>
            </div>
        `;
    }).join('');

    // ì…ì°° ê°€ëŠ¥/ë§ˆê° ìƒíƒœ ì—…ë°ì´íŠ¸ (íƒ€ì´ë¨¸ì™€ ì—°ë™)
    updateTimerDisplay(true);
}

/** 1ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ ë¡œì§ */
function updateTimerDisplay(forceUpdate = false) {
    if (!currentProduct) return;
    
    const endTime = new Date(currentProduct.end_date).getTime();
    const now = new Date().getTime();
    const remainingTime = endTime - now;
    
    const timerEl = document.getElementById('timerDisplay');
    const formSection = document.getElementById('bidFormSection');
    const finishedMsg = document.getElementById('auctionFinishedMessage');
    const placeBidBtn = document.getElementById('placeBidBtn');
    
    if (remainingTime <= 0) {
        // ê²½ë§¤ ë§ˆê° ì²˜ë¦¬
        timerEl.innerHTML = '<span class="text-red-600 font-bold">ê²½ë§¤ ì¢…ë£Œ: ë§ˆê°</span>';
        timerEl.classList.remove('text-2xl', 'text-gray-700');
        timerEl.classList.add('text-3xl');
        formSection.style.display = 'none';
        finishedMsg.style.display = 'block';

        // ë§ˆê° ì‹œ ì…ì°° ì •ë³´ ìƒˆë¡œê³ ì¹¨ (ìµœì¢… ìµœê³ ê°€ í™•ì •)
        if (currentProduct.is_sold !== true || forceUpdate) {
            // is_soldê°€ DBì— ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°, ì¬ë¡œë“œí•˜ì—¬ ìµœì‹  ìƒíƒœ í™•ì¸
            console.log("ê²½ë§¤ ë§ˆê° ê°ì§€, ìƒí’ˆ ì •ë³´ ì¬í™•ì¸");
            // loadProductDetail(); // ê²½ë§¤ ë§ˆê° ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì€ ì‚¬ìš©ì ê²½í—˜ì„ í•´ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ìƒíƒœë§Œ ë³€ê²½
        }
        return;
    }

    // ì‹œê°„ ê³„ì‚°
    const days = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
    const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

    let timeString = '';
    if (days > 0) {
        timeString += `${days}ì¼ `;
    }
    timeString += `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    timerEl.innerHTML = `ê²½ë§¤ ì¢…ë£Œê¹Œì§€: <span class="${remainingTime < 3600000 ? 'text-red-600' : 'text-blue-600'}">${timeString}</span>`;
    
    // ì…ì°° ë²„íŠ¼ í™œì„±í™”
    formSection.style.display = 'block';
    finishedMsg.style.display = 'none';
    if(placeBidBtn) placeBidBtn.disabled = !currentUser;
    
    if (!currentUser) {
        document.getElementById('bidMessage').textContent = 'ì…ì°°í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.';
    } else {
        document.getElementById('bidMessage').textContent = '';
    }
}


// ----------------------------------------------------
// ğŸ”¥ 2. ì…ì°° ë¡œì§
// ----------------------------------------------------
async function placeBid() {
    if (!currentUser) {
        alert('ë¡œê·¸ì¸ í›„ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        return window.location.href = 'auth_login.html';
    }

    const bidInput = document.getElementById('bidInput');
    const bidAmount = Number(bidInput.value);

    if (isNaN(bidAmount) || bidAmount <= 0) {
        return alert('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    }

    const { latestBid } = await getBidData(productId);
    const priceStart = currentProduct.price_start || 0;
    const currentPrice = latestBid ? latestBid.price : priceStart;
    
    if (bidAmount <= currentPrice) {
        return alert(`í˜„ì¬ ìµœê³ ê°€(${currentPrice.toLocaleString('ko-KR')}ì›)ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`);
    }

    const { error } = await supabase
        .from('bids')
        .insert([{ 
            product_id: productId, 
            bidder_id: currentUser.id, 
            price: bidAmount 
        }]);

    if (error) {
        return alert('ì…ì°° ì‹¤íŒ¨: ' + error.message);
    }

    alert('ì…ì°° ì„±ê³µ! ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.');
    bidInput.value = ''; 
    // ì„±ê³µ í›„ ìˆ˜ë™ìœ¼ë¡œ ì…ì°° ì •ë³´ë§Œ ê°±ì‹ 
    updateBidInfo();
}

// ----------------------------------------------------
// ğŸ”¥ 3. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë° êµ¬ë…
// ----------------------------------------------------
function subscribeToRealtime() {
    if (!supabase || !productId) return;

    // 'bids' í…Œì´ë¸” ë³€ê²½ ê°ì§€ (ìƒˆ ì…ì°° ë°œìƒ)
    supabase.channel(`product:${productId}_bids`)
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'bids',
            filter: `product_id=eq.${productId}`
        }, payload => {
            console.log('í•´ë‹¹ ìƒí’ˆì˜ ìƒˆë¡œìš´ ì…ì°° ê°ì§€:', payload);
            updateBidInfo(); // í•´ë‹¹ ìƒí’ˆì˜ ì…ì°° ì •ë³´ë§Œ ìƒˆë¡œê³ ì¹¨
        })
        .subscribe();
}

// ----------------------------------------------------
// ğŸ”¥ 4. ì¸ì¦ ë° ì´ˆê¸°í™”
// ----------------------------------------------------
async function checkAuthAndInit() {
    productId = getProductIdFromUrl();
    if (!supabase || !productId) {
        document.getElementById('loading').textContent = 'ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ìƒí’ˆ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
        return;
    }

    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session ? session.user : null;

    // UI ì—…ë°ì´íŠ¸ (index.htmlê³¼ ë™ì¼í•œ ë¡œì§)
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const signupBtn = document.getElementById('signupBtn');
    const userBox = document.getElementById('userBox');

    if (currentUser) {
        if (loginBtn) loginBtn.style.display = 'none';
        if (signupBtn) signupBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'inline-flex';
        if (userBox) userBox.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.email.split('@')[0]}ë‹˜!`;
    } else {
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (signupBtn) signupBtn.style.display = 'inline-flex';
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (userBox) userBox.textContent = '';
    }
    
    loadProductDetail();
    subscribeToRealtime();
}

async function logout() {
    if (!supabase) return;
    const { error } = await supabase.auth.signOut();
    if (error) {
        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message);
    } else {
        alert('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
        window.location.reload(); 
    }
}

document.addEventListener('DOMContentLoaded', checkAuthAndInit);
</script>
</body>
</html>
